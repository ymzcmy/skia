name: Build Skia m142 (Windows x64 static, LLVM)

on:
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]
  workflow_dispatch:

env:
  SKIA_VERSION: m142
  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ LLVM 19.1.0 (æ»¡è¶³ Skia m142 è¦æ±‚)
  LLVM_URL: https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-win64.exe
  DEPOT_TOOLS_URL: https://storage.googleapis.com/chrome-infra/depot_tools.zip
  LLVM_PATH: C:/LLVM
  # ä¼˜åŒ–çš„æ ¸å¿ƒ 2D å›¾å½¢åŠŸèƒ½é…ç½®
  GN_ARGS_BASE: |
    # åŸºç¡€æ„å»ºé…ç½®
    target_cpu="x64"
    is_component_build=false  # é™æ€åº“æ„å»ºï¼Œé€‚åˆåˆ†å‘
    clang_win="C:/LLVM"
    cc="clang-cl"
    cxx="clang-cl"
    
    # æ ¸å¿ƒ 2D å›¾å½¢èƒ½åŠ› (åŸºäºçŸ¥è¯†åº“ä¸­ Skia çš„å®šä½)
    skia_enable_svg=true      # çŸ¢é‡å›¾å½¢æ”¯æŒ
    skia_enable_gpu=true      # GPU åŠ é€Ÿæ¸²æŸ“
    skia_use_angle=true       # è·¨å¹³å° GPU å…¼å®¹
    
    # å›¾åƒå¤„ç† (ç²¾ç®€ï¼Œç§»é™¤ WebP)
    skia_use_system_libjpeg=false
    skia_use_system_libpng=false
    skia_use_system_zlib=false
    skia_use_system_webp=false  # è£å‰ª WebP æ”¯æŒ
    
    # é«˜çº§æ–‡æœ¬æ¸²æŸ“
    skia_enable_paragraph=true
    skia_enable_skshaper=true
    skia_use_system_freetype2=false
    skia_use_icu=true
    skia_use_system_icu=false
    
    # è§†è§‰æ•ˆæœ (ä¿æŒä¸°å¯Œè§†è§‰ä½“éªŒ)
    skia_enable_skottie=true   # Lottie åŠ¨ç”»
    skia_enable_effects=true
    skia_enable_filters=true
    
    # XML æ”¯æŒ (SVG ä¾èµ–)
    skia_use_expat=true
    skia_use_system_expat=false
    
    # å†—ä½™åŠŸèƒ½è£å‰ª (ä¼˜åŒ–ä½“ç§¯)
    skia_use_xps=false
    skia_enable_pdf=false
    skia_enable_flutter_defines=false
    skia_enable_nvpr=false
    skia_enable_spirv_validation=false
  RELEASE_NAME: "Skia-m142-Nightly-Windows"

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Release, Debug]
    steps:
      - name: Checkout Skia (from own repo)
        run: |
          echo "ğŸ” æ£€å‡º Skia ä»£ç åº“ (2D å›¾å½¢æ ¸å¿ƒåº“)"
          git clone https://github.com/ymzcmy/skia.git skia
          cd skia
          git checkout chrome/${{ env.SKIA_VERSION }}
          git submodule update --init --recursive  # ç¡®ä¿æ‰€æœ‰å­æ¨¡å—åˆå§‹åŒ–

      - name: Install Depot Tools (with update)
        run: |
          echo "ğŸ”§ å®‰è£…æ„å»ºå·¥å…·é“¾"
          curl -Lo depot_tools.zip ${{ env.DEPOT_TOOLS_URL }}
          7z x depot_tools.zip -o"C:\depot_tools" -y
          echo "C:\depot_tools" >> $env:GITHUB_PATH
          cd C:\depot_tools
          git checkout main
          git pull

      - name: Initialize depot_tools
        run: |
          echo "âš™ï¸ åˆå§‹åŒ– depot_tools"
          cd C:\depot_tools
          echo "solutions = []" > .gclient
          gclient
          del .gclient

      - name: Install LLVM (silent install)
        shell: pwsh
        run: |
          $installPath = "C:\LLVM"
          echo "ğŸ“¦ å‡†å¤‡å®‰è£… LLVM 19.1.0 (C++ ç¼–è¯‘å™¨)"
          
          if (-not (Test-Path $installPath)) {
            New-Item -ItemType Directory -Path $installPath -Force | Out-Null
            Write-Host "âœ… åˆ›å»ºå®‰è£…ç›®å½•: $installPath" -ForegroundColor Green
          }
          
          $llvmExe = Join-Path $env:TEMP "llvm.exe"
          Write-Host "â¬‡ï¸ ä¸‹è½½ LLVM å®‰è£…ç¨‹åº: ${{ env.LLVM_URL }}" -ForegroundColor Cyan
          Invoke-WebRequest -Uri ${{ env.LLVM_URL }} -OutFile $llvmExe
          
          $fileInfo = Get-Item $llvmExe
          Write-Host "ğŸ“„ å®‰è£…ç¨‹åºä¿¡æ¯:"
          Write-Host "   åç§°: $($fileInfo.Name)"
          Write-Host "   å¤§å°: $($fileInfo.Length / 1MB -as [int]) MB"
          
          Write-Host "ğŸš€ å®‰è£… LLVM åˆ° $installPath..." -ForegroundColor Cyan
          $installArgs = "/S", "/D=$installPath"
          $proc = Start-Process -FilePath $llvmExe -ArgumentList $installArgs -Wait -PassThru -NoNewWindow
          
          if ($proc.ExitCode -ne 0) {
            Write-Error "âŒ LLVM å®‰è£…å¤±è´¥! é€€å‡ºç : $($proc.ExitCode)"
            if (Test-Path $installPath) {
              Write-Host "ğŸ“ å®‰è£…ç›®å½•å†…å®¹:"
              Get-ChildItem -Path $installPath -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
            }
            exit 1
          }
          
          Write-Host "âœ… LLVM å®‰è£…æˆåŠŸ!" -ForegroundColor Green
          
          $clangPath = Join-Path $installPath "bin\clang-cl.exe"
          $llvmDir = Get-ChildItem -Path $installPath -Directory | Select-Object -First 1
          
          if ($llvmDir) {
            $possibleClangPath = Join-Path $llvmDir.FullName "bin\clang-cl.exe"
            if (Test-Path $possibleClangPath) {
              Write-Host "âš ï¸ LLVM å®é™…å®‰è£…åœ¨: $($llvmDir.FullName)" -ForegroundColor Yellow
              $installPath = $llvmDir.FullName
              $clangPath = $possibleClangPath
            }
          }
          
          if (-not (Test-Path $clangPath)) {
            Write-Error "âŒ é”™è¯¯: $clangPath ä¸å­˜åœ¨!"
            Write-Host "ğŸ“ å®‰è£…ç›®å½•ç»“æ„:"
            Get-ChildItem -Path $installPath -Recurse | ForEach-Object { 
              $indent = " " * $_.FullName.Replace($installPath, "").Split('\').Count
              Write-Host "${indent}$($_.Name)"
            }
            exit 1
          }
          
          Write-Host "âœ… æ‰¾åˆ° clang-cl.exe: $clangPath" -ForegroundColor Green
          
          $env:Path += ";$installPath\bin"
          [System.Environment]::SetEnvironmentVariable("Path", $env:Path, "Machine")
          Write-Host "ğŸ”§ PATH å·²æ›´æ–°" -ForegroundColor Green
          
          Write-Host "ğŸ” éªŒè¯ LLVM å®‰è£…..." -ForegroundColor Cyan
          $version = & clang-cl --version 2>&1
          Write-Host "LLVM ç‰ˆæœ¬: $version"
          
          # ç‰ˆæœ¬éªŒè¯ (ç¡®ä¿ >= 19.0.0)
          $versionMatch = $version | Select-String -Pattern "clang version (\d+\.\d+)"
          if ($versionMatch -and $versionMatch.Matches.Count -gt 0) {
            $versionStr = $versionMatch.Matches[0].Groups[1].Value
            $majorVersion = [int]$versionStr.Split('.')[0]
            if ($majorVersion -lt 19) {
              Write-Error "âŒ LLVM ç‰ˆæœ¬ $versionStr ä½äº Skia m142 è¦æ±‚çš„ 19.0.0"
              exit 1
            }
            Write-Host "âœ… LLVM ç‰ˆæœ¬ $versionStr æ»¡è¶³è¦æ±‚ (>= 19.0.0)" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸ æ— æ³•è§£æ LLVM ç‰ˆæœ¬ï¼Œä½†å®‰è£…çœ‹èµ·æ¥æˆåŠŸ" -ForegroundColor Yellow
          }

      - name: åˆ›å»º emsdk é˜²å¾¡è„šæœ¬
        shell: pwsh
        working-directory: skia
        run: |
          echo "ğŸ›¡ï¸ åˆ›å»º emsdk é˜²å¾¡è„šæœ¬ (ç¡®ä¿æ„å»ºä¸è¢«ä¸­æ–­)"
          $binPath = Join-Path -Path $pwd -ChildPath "bin"
          if (-not (Test-Path $binPath)) {
            New-Item -ItemType Directory -Path $binPath -Force | Out-Null
          }
          
          # åˆ›å»ºé˜²å¾¡æ€§è„šæœ¬
          $pyContent = "import sys`r`nsys.exit(0)"
          $pyPath = Join-Path $binPath "activate-emsdk"
          [System.IO.File]::WriteAllText($pyPath, $pyContent)
          
          $batContent = "@echo off`r`nexit /b 0"
          $batPath = Join-Path $binPath "activate-emsdk.bat"
          [System.IO.File]::WriteAllText($batPath, $batContent)
          
          $ps1Content = "exit 0"
          $ps1Path = Join-Path $binPath "activate-emsdk.ps1"
          [System.IO.File]::WriteAllText($ps1Path, $ps1Content)
          
          # éªŒè¯è„šæœ¬
          $tests = @(
            @{Name="Python"; Cmd="python $pyPath"},
            @{Name="Batch"; Cmd="cmd /c $batPath"},
            @{Name="PowerShell"; Cmd="powershell -ExecutionPolicy Bypass -File $ps1Path"}
          )
          
          $allPassed = $true
          foreach ($test in $tests) {
            try {
              Invoke-Expression $test.Cmd
              if ($LASTEXITCODE -ne 0) {
                Write-Error "âŒ $($test.Name) æµ‹è¯•å¤±è´¥ (é€€å‡ºç  $LASTEXITCODE): $($test.Cmd)"
                $allPassed = $false
              } else {
                Write-Host "âœ… $($test.Name) æµ‹è¯•æˆåŠŸ: $($test.Cmd)" -ForegroundColor Green
              }
            } catch {
              Write-Error "âŒ $($test.Name) æ‰§è¡Œå¼‚å¸¸: $_"
              $allPassed = $false
            }
          }
          
          if (-not $allPassed) {
            Write-Error "âŒ é˜²å¾¡è„šæœ¬æµ‹è¯•æœªé€šè¿‡ï¼Œæ„å»ºä¸­æ­¢"
            exit 1
          }
          
          [Environment]::SetEnvironmentVariable("NO_EMSCRIPTEN", "1", "Process")
          $env:NO_EMSCRIPTEN = "1"
          Write-Host "âœ… NO_EMSCRIPTEN=1 (ç¯å¢ƒå˜é‡è®¾ç½®æˆåŠŸ)" -ForegroundColor Green

      - name: åŒæ­¥ç¬¬ä¸‰æ–¹ä¾èµ–
        working-directory: skia
        shell: pwsh
        run: |
          echo "ğŸ”— åŒæ­¥ç¬¬ä¸‰æ–¹ä¾èµ– (å›¾åƒå¤„ç†å’Œæ–‡æœ¬æ¸²æŸ“åº“)"
          $python = "C:\hostedtoolcache\windows\Python\3.9.13\x64\python.exe"
          if (-not (Test-Path $python)) {
            Write-Error "âŒ Python æœªæ‰¾åˆ°!"
            exit 1
          }
          
          $cmd = "$python tools\git-sync-deps --deps-target=win --no-emsdk"
          Write-Host "â¡ï¸ æ‰§è¡Œå‘½ä»¤: $cmd" -ForegroundColor Cyan
          
          $output = cmd /c "$cmd"
          $exitCode = $LASTEXITCODE
          
          if ($exitCode -ne 0) {
            Write-Error "âŒ ä¾èµ–åŒæ­¥å¤±è´¥! é€€å‡ºç : $exitCode"
            Write-Error "è¯¦ç»†è¾“å‡º:"
            $output | ForEach-Object { Write-Error "  $_" }
            exit $exitCode
          }
          
          Write-Host "âœ… ä¾èµ–åŒæ­¥æˆåŠŸ!" -ForegroundColor Green
          $output | ForEach-Object { Write-Host "  $_" }

      - name: ç”Ÿæˆ GN æ„å»ºå‚æ•°
        shell: pwsh
        working-directory: skia
        run: |
          echo "âš™ï¸ ç”Ÿæˆ GN æ„å»ºå‚æ•° (æ ¸å¿ƒ 2D å›¾å½¢åº“é…ç½®)"
          
          # åŸºç¡€é…ç½®
          $gnArgs = $env:GN_ARGS_BASE
          
          # æ ¹æ®æ„å»ºç±»å‹æ·»åŠ ç‰¹å®šé…ç½®
          if ("${{ matrix.config }}" -eq "Debug") {
            $gnArgs = $gnArgs + "`n`nis_debug=true`nis_official_build=false`nextra_cflags=[`"/MTd`"]`n"
          } else {
            $gnArgs = $gnArgs + "`n`nis_debug=false`nis_official_build=true`nextra_cflags=[`"/MT`"]`n"
          }
          
          $outDir = "out\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          
          $argsPath = Join-Path -Path $outDir -ChildPath "args.gn"
          [System.IO.File]::WriteAllText($argsPath, $gnArgs)
          
          Write-Host "âœ… å·²ç”Ÿæˆ GN å‚æ•°: $argsPath" -ForegroundColor Green
          Write-Host "ğŸ“ æ„å»ºå‚æ•°è¯¦æƒ…:"
          Get-Content $argsPath | ForEach-Object { Write-Host "   $_" }

      - name: ç”¨ GN ç”Ÿæˆæ„å»ºæ–‡ä»¶
        working-directory: skia
        run: |
          echo "ğŸ”§ ç”¨ GN ç”Ÿæˆæ„å»ºæ–‡ä»¶ (å‡†å¤‡ C++ ç¼–è¯‘)"
          gn gen "out/${{ matrix.config }}"

      - name: ç”¨ Ninja ç¼–è¯‘
        working-directory: skia
        run: ninja -C "out/${{ matrix.config }}" skia

      - name: æ”¶é›†æ„å»ºäº§ç‰©
        shell: pwsh
        working-directory: skia
        run: |
          echo "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
          $config = "${{ matrix.config }}"
          $dst = "${{ github.workspace }}\skia-${{ env.SKIA_VERSION }}-windows-x64-${config}"
          
          New-Item -Path "$dst\include" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\lib" -ItemType Directory -Force | Out-Null
          
          # å¤åˆ¶å¤´æ–‡ä»¶
          robocopy "include" "$dst\include" /E /NP /NFL /NDL /R:1 /W:1
          if ($LASTEXITCODE -gt 7) { 
            Write-Error "âŒ å¤´æ–‡ä»¶å¤åˆ¶å¤±è´¥ (é”™è¯¯ç : $LASTEXITCODE)"
            exit $LASTEXITCODE 
          }
          
          # å¤åˆ¶åº“æ–‡ä»¶å’Œå…ƒæ•°æ®
          Copy-Item "out\${config}\*.lib" -Destination "$dst\lib" -Force
          Copy-Item "out\${config}\args.gn" -Destination "$dst" -Force
          Copy-Item "LICENSE" -Destination "$dst" -Force
          
          # åˆ›å»º ZIP å½’æ¡£
          Compress-Archive -Path "$dst\*" -DestinationPath "${dst}.zip" -Force
          
          # æ˜¾ç¤ºå¤§å°
          $zipSize = [math]::Round((Get-Item "${dst}.zip").Length / 1MB, 2)
          Write-Host "âœ… äº§ç‰©å·²æ‰“åŒ…: ${dst}.zip (${zipSize} MB)" -ForegroundColor Green

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}
          path: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip

      - name: ä¸Šä¼ åˆ° Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/chrome/m142'
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_NAME }}
          update: true
          body: |
            **Skia m142 è‡ªåŠ¨æ„å»º (Windows x64)**
            
            Skia æ˜¯ä¸€ä¸ªå®Œæ•´çš„ 2D å›¾å½¢åº“ï¼Œç”¨äºç»˜åˆ¶**æ–‡æœ¬**ã€**å‡ ä½•å›¾å½¢**å’Œ**å›¾åƒ**ã€‚
            
            **æ„å»ºè¯¦æƒ…**:
            - åˆ†æ”¯: `${{ github.ref_name }}`  
            - æäº¤: `${{ github.sha }}`  
            - æ„å»ºæ—¶é—´: `${{ github.event.head_commit.timestamp }}`  
            - é…ç½®: `${{ matrix.config }}`  
            - æ ¸å¿ƒåŠŸèƒ½:
              - GPU åŠ é€Ÿæ¸²æŸ“ (ANGLE)
              - SVG çŸ¢é‡å›¾å½¢
              - é«˜çº§æ–‡æœ¬æ’ç‰ˆ (Paragraph, SkShaper)
              - åŠ¨ç”»æ”¯æŒ (Skottie/Lottie)
            - è£å‰ªåŠŸèƒ½:
              - WebP å›¾åƒæ ¼å¼
              - XPS æ–‡æ¡£
              - PDF ç”Ÿæˆ
            
            > æ­¤æ„å»ºé’ˆå¯¹ Windows x64 å¹³å°ä¼˜åŒ–ï¼Œä½¿ç”¨ LLVM 19.1.0 ç¼–è¯‘
          files: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
