name: Build Skia m142 (Windows x64 static, LLVM)

on:
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]
  workflow_dispatch:

env:
  SKIA_VERSION: m142
  LLVM_URL: https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/LLVM-17.0.6-win64.exe
  DEPOT_TOOLS_URL: https://storage.googleapis.com/chrome-infra/depot_tools.zip
  # å…³é”®ä¿®å¤ï¼šä½¿ç”¨æ— ç©ºæ ¼è·¯å¾„
  LLVM_PATH: C:/LLVM
  GN_ARGS_BASE: |
    target_cpu="x64"
    is_official_build=true
    is_component_build=false
    is_debug=false
    # ä½¿ç”¨æ— ç©ºæ ¼è·¯å¾„
    clang_win="C:/LLVM"
    cc="clang-cl"
    cxx="clang-cl"
    extra_cflags=["/MT"]
    skia_use_system_libjpeg=true
    skia_use_system_libpng=true
    skia_use_system_zlib=true
    skia_use_system_freetype2=false
    skia_use_system_harfbuzz=false
    skia_use_system_webp=false
    skia_enable_svg=true
    skia_enable_skottie=true
    skia_enable_skshaper=true
    skia_enable_paragraph=true
    skia_enable_effects=true
    skia_enable_filters=true
    skia_use_expat=true
    skia_use_system_expat=false
    skia_use_icu=false
    skia_use_xps=false
    skia_enable_gpu=false
    skia_use_angle=false
  RELEASE_NAME: "Skia-m142-Nightly-Windows"

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Release, Debug]
    steps:
      - name: Checkout Skia (from own repo)
        run: |
          git clone https://github.com/ymzcmy/skia.git skia
          cd skia
          git checkout chrome/${{ env.SKIA_VERSION }}

      - name: Install Depot Tools (with update)
        run: |
          curl -Lo depot_tools.zip ${{ env.DEPOT_TOOLS_URL }}
          7z x depot_tools.zip -o"C:\depot_tools" -y
          echo "C:\depot_tools" >> $env:GITHUB_PATH
          cd C:\depot_tools
          git checkout main
          git pull

      # ===== å…³é”®ä¿®å¤ï¼šdepot_tools åˆå§‹åŒ– =====
      - name: Initialize depot_tools (è§£å†³ python3_bin_reldir.txt é—®é¢˜)
        run: |
          cd C:\depot_tools
          echo "solutions = []" > .gclient
          gclient
          del .gclient

      # ===== å…³é”®ä¿®å¤ï¼šå®‰è£… LLVM åˆ°æ— ç©ºæ ¼è·¯å¾„ =====
      - name: Install LLVM (silent install, ä¿®å¤ç‰ˆ)
        run: |
          # 1. æ˜Žç¡®åˆ›å»ºå®‰è£…ç›®å½•å¹¶éªŒè¯
          $installPath = "C:\LLVM"
          if (-not (Test-Path $installPath)) {
            $dir = New-Item -ItemType Directory -Path $installPath -Force -ErrorAction Stop
            Write-Host "æˆåŠŸåˆ›å»ºç›®å½•: $($dir.FullName)"
          } else {
            Write-Host "ç›®å½•å·²å­˜åœ¨: $installPath"
          }
          
          # 2. ä¸‹è½½ LLVM å¹¶éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
          $llvmExe = Join-Path $env:TEMP "llvm.exe"
          try {
            Invoke-WebRequest -Uri ${{ env.LLVM_URL }} -OutFile $llvmExe -ErrorAction Stop
            Write-Host "LLVM å®‰è£…åŒ…ä¸‹è½½æˆåŠŸ: $llvmExe"
          } catch {
            Write-Error "LLVM ä¸‹è½½å¤±è´¥: $_"
            exit 1
          }
          
          # 3. æ‰§è¡Œå®‰è£…å¹¶æ•èŽ·é”™è¯¯
          try {
            Write-Host "å¼€å§‹å®‰è£… LLVM åˆ°: $installPath"
            & $llvmExe /S /D=$installPath -ErrorAction Stop
            Write-Host "LLVM å®‰è£…å®Œæˆ"
          } catch {
            Write-Error "LLVM å®‰è£…å¤±è´¥: $_"
            exit 1
          }
          
          # 4. éªŒè¯å…³é”®æ–‡ä»¶ï¼ˆè‹¥ç¼ºå¤±ï¼Œæ£€æŸ¥é»˜è®¤å®‰è£…è·¯å¾„ï¼‰
          $clangPath = Join-Path $installPath "bin\clang-cl.exe"
          $defaultClangPath = Join-Path "C:\Program Files\LLVM" "bin\clang-cl.exe"
          
          if (Test-Path $clangPath) {
            Write-Host "éªŒè¯æˆåŠŸ: $clangPath å­˜åœ¨"
          } elseif (Test-Path $defaultClangPath) {
            Write-Warning "LLVM å®‰è£…åˆ°é»˜è®¤è·¯å¾„: $defaultClangPathï¼ˆåŽŸç›®æ ‡è·¯å¾„ $installPath æœªæ‰¾åˆ°ï¼‰"
            $installPath = "C:\Program Files\LLVM"  # ä¿®æ­£å®‰è£…è·¯å¾„
            $clangPath = $defaultClangPath
          } else {
            Write-Error "LLVM å®‰è£…å¤±è´¥ï¼æœªæ‰¾åˆ° clang-cl.exeï¼ˆæ£€æŸ¥è¿‡ $clangPath å’Œ $defaultClangPathï¼‰"
            exit 1
          }
          
          # 5. æ›´æ–° PATHï¼ˆåŒæ—¶æ›´æ–°å½“å‰ä¼šè¯å’Œç³»ç»ŸçŽ¯å¢ƒå˜é‡ï¼‰
          $binPath = Join-Path $installPath "bin"
          if ($env:Path -notlike "*$binPath*") {
            $env:Path += ";$binPath"  # å½“å‰ä¼šè¯ç”Ÿæ•ˆ
            [System.Environment]::SetEnvironmentVariable("Path", "$($env:Path)", "Machine")  # ç³»ç»Ÿçº§ç”Ÿæ•ˆ
          }
          
          # 6. æœ€ç»ˆéªŒè¯å·¥å…·å¯ç”¨æ€§
          try {
            Write-Host "LLVM ç‰ˆæœ¬ä¿¡æ¯:"
            & clang-cl --version
          } catch {
            Write-Error "clang-cl è°ƒç”¨å¤±è´¥ï¼Œå¯èƒ½ PATH æœªç”Ÿæ•ˆ: $_"
            exit 1
          }

      - name: åˆ›å»º 100% å®‰å…¨çš„ emsdk é˜²å¾¡è„šæœ¬
        shell: pwsh
        working-directory: skia
        run: |
          $binPath = Join-Path -Path $pwd -ChildPath "bin"
          if (-not (Test-Path $binPath)) {
            New-Item -ItemType Directory -Path $binPath -Force | Out-Null
          }
          
          # åˆ›å»ºä¸‰ç§æ ¼å¼çš„é˜²å¾¡è„šæœ¬
          $pyContent = "import sys`r`nsys.exit(0)"
          $pyPath = Join-Path $binPath "activate-emsdk"
          [System.IO.File]::WriteAllText($pyPath, $pyContent)
          
          $batContent = "@echo off`r`nexit /b 0"
          $batPath = Join-Path $binPath "activate-emsdk.bat"
          [System.IO.File]::WriteAllText($batPath, $batContent)
          
          $ps1Content = "exit 0"
          $ps1Path = Join-Path $binPath "activate-emsdk.ps1"
          [System.IO.File]::WriteAllText($ps1Path, $ps1Content)
          
          # éªŒè¯æ‰€æœ‰è„šæœ¬
          $tests = @(
            @{Name="Python"; Cmd="python $pyPath"},
            @{Name="Batch"; Cmd="cmd /c $batPath"},
            @{Name="PowerShell"; Cmd="powershell -ExecutionPolicy Bypass -File $ps1Path"}
          )
          
          $allPassed = $true
          foreach ($test in $tests) {
            try {
              Invoke-Expression $test.Cmd
              if ($LASTEXITCODE -ne 0) {
                Write-Error "âŒ $($test.Name) æµ‹è¯•å¤±è´¥ (é€€å‡ºç  $LASTEXITCODE): $($test.Cmd)"
                $allPassed = $false
              } else {
                Write-Host "âœ… $($test.Name) æµ‹è¯•æˆåŠŸ: $($test.Cmd)"
              }
            } catch {
              Write-Error "âŒ $($test.Name) æ‰§è¡Œå¼‚å¸¸: $_"
              $allPassed = $false
            }
          }
          
          if (-not $allPassed) {
            Write-Error "âŒ é˜²å¾¡è„šæœ¬æµ‹è¯•æœªé€šè¿‡ï¼Œæž„å»ºä¸­æ­¢"
            exit 1
          }
          
          [Environment]::SetEnvironmentVariable("NO_EMSCRIPTEN", "1", "Process")
          $env:NO_EMSCRIPTEN = "1"
          Write-Host "âœ… NO_EMSCRIPTEN=1 (è¿›ç¨‹çº§ + å½“å‰ä¼šè¯)"

      - name: åŒæ­¥ç¬¬ä¸‰æ–¹ä¾èµ–
        working-directory: skia
        shell: pwsh
        run: |
          $python = "C:\hostedtoolcache\windows\Python\3.9.13\x64\python.exe"
          if (-not (Test-Path $python)) {
            Write-Error "âŒ Python æœªæ‰¾åˆ°!"
            exit 1
          }
          
          $cmd = "$python tools\git-sync-deps --deps-target=win --no-emsdk"
          Write-Host "âž¡ï¸ æ‰§è¡Œå‘½ä»¤: $cmd"
          
          $output = cmd /c "$cmd"
          $exitCode = $LASTEXITCODE
          
          if ($exitCode -ne 0) {
            Write-Error "âŒ ä¾èµ–åŒæ­¥å¤±è´¥! é€€å‡ºç : $exitCode"
            Write-Error "è¯¦ç»†è¾“å‡º:"
            $output | ForEach-Object { Write-Error "  $_" }
            exit $exitCode
          }
          
          Write-Host "âœ… ä¾èµ–åŒæ­¥æˆåŠŸ!" -ForegroundColor Green
          $output | ForEach-Object { Write-Host "  $_" }

      - name: ç”Ÿæˆ GN æž„å»ºå‚æ•°
        shell: pwsh
        working-directory: skia
        run: |
          $gnArgs = @"
          target_cpu="x64"
          is_official_build=true
          is_component_build=false
          is_debug=false
          clang_win="C:/LLVM"
          cc="clang-cl"
          cxx="clang-cl"
          extra_cflags=["/MT"]
          skia_use_system_libjpeg=true
          skia_use_system_libpng=true
          skia_use_system_zlib=true
          skia_use_system_freetype2=false
          skia_use_system_harfbuzz=false
          skia_use_system_webp=false
          skia_enable_svg=true
          skia_enable_skottie=true
          skia_enable_skshaper=true
          skia_enable_paragraph=true
          skia_enable_effects=true
          skia_enable_filters=true
          skia_use_expat=true
          skia_use_system_expat=false
          skia_use_icu=false
          skia_use_xps=false
          skia_enable_gpu=false
          skia_use_angle=false
          "@
          
          if ("${{ matrix.config }}" -eq "Debug") {
            $gnArgs = $gnArgs.Replace('is_debug=false', 'is_debug=true')
            $gnArgs = $gnArgs.Replace('extra_cflags=["/MT"]', 'extra_cflags=["/MTd"]')
          }
          
          $outDir = "out\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          
          $argsPath = Join-Path -Path $outDir -ChildPath "args.gn"
          [System.IO.File]::WriteAllText($argsPath, $gnArgs)
          
          Write-Host "âœ… å·²ç”Ÿæˆ GN å‚æ•°: $argsPath"
          Get-Content $argsPath

      # ===== å…³é”®ä¿®å¤ï¼šéªŒè¯ LLVM è·¯å¾„ =====
      - name: ç”¨ GN ç”Ÿæˆæž„å»ºæ–‡ä»¶
        working-directory: skia
        run: |
          echo "éªŒè¯ LLVM è·¯å¾„..."
          dir "C:\LLVM\lib"
          echo "PATH: %PATH%"
          gclient --version
          gn --version
          gn gen "out/${{ matrix.config }}"

      - name: ç”¨ Ninja ç¼–è¯‘
        working-directory: skia
        run: ninja -C "out/${{ matrix.config }}" skia

      - name: æ”¶é›†æž„å»ºäº§ç‰©
        shell: pwsh
        working-directory: skia
        run: |
          $config = "${{ matrix.config }}"
          $dst = "${{ github.workspace }}\skia-${{ env.SKIA_VERSION }}-windows-x64-${config}"
          
          New-Item -Path "$dst\include" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\lib" -ItemType Directory -Force | Out-Null
          
          robocopy "include" "$dst\include" /E /NP /NFL /NDL /R:1 /W:1
          if ($LASTEXITCODE -gt 7) { 
            Write-Error "å¤´æ–‡ä»¶å¤åˆ¶å¤±è´¥ (é”™è¯¯ç : $LASTEXITCODE)"; exit $LASTEXITCODE 
          }
          
          Copy-Item "out\${config}\*.lib" -Destination "$dst\lib" -Force
          Copy-Item "out\${config}\args.gn" -Destination "$dst" -Force
          Copy-Item "LICENSE" -Destination "$dst" -Force
          
          Compress-Archive -Path "$dst\*" -DestinationPath "${dst}.zip" -Force
          Write-Host "ðŸ“¦ äº§ç‰©å·²æ‰“åŒ…: ${dst}.zip"

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}
          path: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip

      - name: ä¸Šä¼ åˆ°å›ºå®š Release (è¦†ç›–æ›´æ–°)
        if: (github.event_name == 'push' && github.ref == 'refs/heads/chrome/m142') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_NAME }}
          update: true
          body: |
            **è‡ªåŠ¨æž„å»ºäº§ç‰©**  
            - åˆ†æ”¯: `${{ github.ref_name }}`  
            - æäº¤: `${{ github.sha }}`  
            - æž„å»ºæ—¶é—´: `${{ github.event.head_commit.timestamp }}`  
            - é…ç½®: `${{ matrix.config }}`  
            - Skia ç‰ˆæœ¬: `${{ env.SKIA_VERSION }}`  
            - GitHub Runner: `${{ runner.os }}-${{ runner.arch }}`  
            
            > æ³¨: æ­¤ Release ä¼šè¢«æ–°æž„å»ºè¦†ç›–æ›´æ–°
          files: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
