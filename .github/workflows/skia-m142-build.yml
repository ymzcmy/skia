name: Build Skia m142 (Windows x64 static, LLVM)

on:
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]
  workflow_dispatch:

env:
  SKIA_VERSION: m142
  LLVM_URL: https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/LLVM-17.0.6-win64.exe
  DEPOT_TOOLS_URL: https://storage.googleapis.com/chrome-infra/depot_tools.zip
  GN_ARGS_BASE: |
    target_cpu="x64"
    is_official_build=true
    is_component_build=false
    is_debug=false
    clang_win="C:/Program Files/LLVM"
    cc="clang-cl"
    cxx="clang-cl"
    extra_cflags=["/MT"]   # Release 用 /MT，Debug 用 /MTd
    skia_use_system_libjpeg=true
    skia_use_system_libpng=true
    skia_use_system_zlib=true
    skia_use_system_freetype2=false
    skia_use_system_harfbuzz=false
    skia_use_system_webp=false
    skia_enable_svg=true
    skia_enable_skottie=true
    skia_enable_skshaper=true
    skia_enable_paragraph=true
    skia_enable_effects=true
    skia_enable_filters=true
    skia_use_expat=true
    skia_use_system_expat=false
    skia_use_icu=false
    skia_use_xps=false
    skia_enable_gpu=false
    skia_use_angle=false
  # 固定 Release 名称 (每次覆盖更新)
  RELEASE_NAME: "Skia-m142-Nightly-Windows"

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Release, Debug]
    steps:
      - name: Checkout Skia (from own repo)
        run: |
          git clone https://github.com/ymzcmy/skia.git skia
          cd skia
          git checkout chrome/${{ env.SKIA_VERSION }}

      - name: Install Depot Tools (with update)
        run: |
          curl -Lo depot_tools.zip ${{ env.DEPOT_TOOLS_URL }}
          7z x depot_tools.zip -o"C:\depot_tools" -y
          echo "C:\depot_tools" >> $env:GITHUB_PATH
          cd C:\depot_tools
          git checkout main
          git pull

      - name: Install LLVM (silent install)
        run: |
          curl -Lo llvm.exe ${{ env.LLVM_URL }}
          ./llvm.exe /S /D="C:\Program Files\LLVM"
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      - name: 彻底禁用 activate-emsdk (Windows 路径兼容)
        working-directory: skia
        shell: pwsh
        run: |
          $emsdkScripts = @(
            (Join-Path -Path "bin" -ChildPath "activate-emsdk"),
            (Join-Path -Path "bin" -ChildPath "activate-emsdk.bat"),
            (Join-Path -Path "bin" -ChildPath "activate-emsdk.ps1")
          )
          foreach ($script in $emsdkScripts) {
            if (Test-Path -LiteralPath $script -ErrorAction SilentlyContinue) {
              $newName = $script + ".disabled"
              Rename-Item -LiteralPath $script -NewName $newName -Force
              Write-Host "已禁用: $script -> $newName" -ForegroundColor Green
            }
            else {
              Write-Host "跳过: $script 不存在" -ForegroundColor Yellow
            }
          }

      - name: 同步第三方依赖 (强制跳过 emsdk)
        working-directory: skia
        shell: cmd
        run: |
          set NO_EMSCRIPTEN=1
          python tools\git-sync-deps --deps-target=win

      - name: 生成 GN 构建参数
        shell: pwsh
        working-directory: skia
        run: |
          $args = "${{ env.GN_ARGS_BASE }}"
          if ("${{ matrix.config }}" -eq "Debug") {
            $args = $args.Replace('is_debug=false', 'is_debug=true')
                         .Replace('extra_cflags=["/MT"]', 'extra_cflags=["/MTd"]')
          }
          $outDir = "out\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $args | Out-File -FilePath "${outDir}\args.gn" -Encoding utf8

      - name: 用 GN 生成构建文件
        working-directory: skia
        run: gn gen "out/${{ matrix.config }}"

      - name: 用 Ninja 编译
        working-directory: skia
        run: ninja -C "out/${{ matrix.config }}" skia

      - name: 收集构建产物
        shell: pwsh
        working-directory: skia
        run: |
          $config = "${{ matrix.config }}"
          $dst = "${{ github.workspace }}\skia-${{ env.SKIA_VERSION }}-windows-x64-${config}"
          
          New-Item -Path "$dst\include" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\lib" -ItemType Directory -Force | Out-Null
          
          robocopy "include" "$dst\include" /E /NP /NFL /NDL /R:1 /W:1
          if ($LASTEXITCODE -gt 7) { 
            Write-Error "头文件复制失败 (错误码: $LASTEXITCODE)"; exit $LASTEXITCODE 
          }
          
          Copy-Item "out\${config}\*.lib" -Destination "$dst\lib" -Force
          Copy-Item "out\${config}\args.gn" -Destination "$dst" -Force
          Copy-Item "LICENSE" -Destination "$dst" -Force
          
          Compress-Archive -Path "$dst\*" -DestinationPath "${dst}.zip" -Force

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}
          path: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip

      # ===== 关键修改：每次成功构建后覆盖更新固定 Release =====
      - name: 上传到固定 Release (覆盖更新)
        # 仅在 main 分支的 push 事件或手动触发时上传 (避免 PR 污染 Release)
        if: (github.event_name == 'push' && github.ref == 'refs/heads/chrome/m142') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          # 指定固定 Release 名称 (会覆盖同名 Release)
          name: ${{ env.RELEASE_NAME }}
          # 覆盖更新已有 Release
          update: true
          # 附加构建信息
          body: |
            **自动构建产物**  
            - 分支: `${{ github.ref_name }}`  
            - 提交: `${{ github.sha }}`  
            - 构建时间: `${{ github.event.head_commit.timestamp }}`  
            - 配置: `${{ matrix.config }}`  
            - Skia 版本: `${{ env.SKIA_VERSION }}`  
            
            > 注: 此 Release 会被新构建覆盖更新
          files: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
