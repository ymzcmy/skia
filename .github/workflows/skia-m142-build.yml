name: Skia Static Build (Windows x64 Debug & Release, chrome/m142, UI Advanced, No DLL)

on:
  workflow_dispatch:
    inputs:
      skia_branch:
        description: 'Skia branch to build (e.g., chrome/m142)'
        required: false
        default: 'chrome/m142'
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]

jobs:
  build-windows:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Debug, Release]
      fail-fast: false

    steps:
      # 1. 拉取Skia源码（含所有子模块）
      - name: Checkout Skia source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.skia_branch || 'chrome/m142' }}
          submodules: recursive
          fetch-depth: 0
          clean: true

      # 2. 安装VS Build Tools（使用微软官方脚本，解决环境变量问题）
      - name: Install Visual Studio Build Tools
        run: |
          $vsInstallerUrl = "https://aka.ms/vs/17/release/vs_BuildTools.exe"
          $installerPath = "$env:TEMP\vs_BuildTools.exe"
          Invoke-WebRequest -Uri $vsInstallerUrl -OutFile $installerPath

          # 安装VCTools工作负载（C++编译核心依赖）
          & $installerPath --quiet --wait --norestart --nocache `
            --installPath "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools" `
            --add Microsoft.VisualStudio.Workload.VCTools `
            --includeRecommended `
            --passive

          # 强制刷新环境变量
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          Write-Host "Refreshed PATH: $env:Path"
        shell: powershell

      # 3. 安装Python 3.11
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 4. 安装Ninja
      - name: Install Ninja
        run: pip install ninja
        shell: cmd

      # 5. 构建GN工具（Skia原生构建系统）
      - name: Build GN Tool
        working-directory: third_party\gn
        shell: cmd
        run: |
          python build/gen.py --no-last-commit-position
          ninja -C out

      # 6. 验证GN工具安装
      - name: Verify GN Installation
        run: third_party\gn\out\gn --version
        shell: cmd

      # 7. 配置GN编译参数（区分Debug/Release）
      - name: Configure GN Args (${{ matrix.config }})
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $isDebug = $config -eq "Debug"
          $optimize = if ($isDebug) { "none" } else { "speed" }
          $runtime = if ($isDebug) { "/MTd" } else { "/MT" }
          
          $gnArgs = @"
          is_debug=$isDebug
          is_official_build=$(!$isDebug)
          target_os="windows"
          target_cpu="x64"
          is_component_build=false
          is_static_lib=true
          skia_enable_gpu=true
          skia_use_direct3d=true
          d3d11_enabled=true
          skia_use_system_libjpeg=false
          skia_use_system_libpng=false
          skia_use_system_zlib=false
          skia_use_system_freetype2=false
          skia_use_system_harfbuzz=false
          skia_use_system_webp=false
          skia_enable_svg=true
          skia_enable_skottie=true
          skia_enable_skshaper=true
          skia_enable_paragraph=true
          skia_enable_effects=true
          skia_enable_filters=true
          optimize="$optimize"
          extra_cflags=["$runtime"]
          win_sdk_version="10.0.22621.0"
          "@
          
          Write-Output "GN Args:"
          Write-Output $gnArgs
          ./third_party/gn/out/gn.exe gen out/$config --args=$gnArgs

      # 8. 编译Skia静态库（限制并发数防止内存溢出）
      - name: Build Skia Static Lib (${{ matrix.config }})
        shell: cmd
        run: |
          set PATH=%PATH%;third_party\gn\out
          ninja -C out/${{ matrix.config }} -j 4
        timeout-minutes: 60

      # 9. 验证编译产物存在性
      - name: Verify Build Outputs (${{ matrix.config }})
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $libPath = "out/$config/skia.lib"
          
          if (-not (Test-Path $libPath)) {
            Write-Error "skia.lib not found at $libPath"
            Get-ChildItem out/$config -Recurse | Format-List
            exit 1
          }
          Write-Host "✅ Found skia.lib at $libPath"
          Write-Host "Size: $(Get-Item $libPath).Length bytes"

      # 10. 打包静态库和头文件
      - name: Package ${{ matrix.config }}
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $outDir = "package/$config"
          $libPath = "out/$config/skia.lib"
          
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          Copy-Item $libPath -Destination "$outDir/skia.lib"
          robocopy "include" "$outDir/include" /E /NJH /NJS /NFL /NDL
          
          "Skia chrome/m142 static build" | Out-File "$outDir/VERSION.txt"
          "Config: $config" | Out-File -Append "$outDir/VERSION.txt"
          Get-Date -Format "yyyy-MM-dd HH:mm" | Out-File -Append "$outDir/VERSION.txt"

      # 11. 上传编译产物（保留30天）
      - name: Upload Artifact ${{ matrix.config }}
        uses: actions/upload-artifact@v4
        with:
          name: skia-windows-x64-static-${{ matrix.config }}-m142
          path: package/${{ matrix.config }}
          retention-days: 30
