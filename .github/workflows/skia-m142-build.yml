name: Skia Static Build (Windows x64 Debug & Release, chrome/m142, UI Advanced, No DLL)

on:
  workflow_dispatch:
    inputs:
      skia_branch:
        description: 'Skia branch to build (e.g., chrome/m142)'
        required: false
        default: 'chrome/m142'
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        config: [Debug, Release]

    steps:
      # 1. 拉取 Skia chrome/m142 分支（含所有子模块）
      - name: Checkout Skia source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.skia_branch || 'chrome/m142' }}
          submodules: recursive  # 必须拉取所有子模块，否则编译失败
          fetch-depth: 0
          clean: true

      # 2. 安装 Python 3.11（GN 依赖）
      - name: Install Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. 编译 GN 工具（Skia 内置构建工具）
      - name: Build GN Tool
        working-directory: ./third_party/gn
        run: |
          python build/gen.py
          ninja -C out

      # 4. 配置 GN 参数（适配 Windows 静态库 + UI 高级功能）
      - name: Configure GN Args
        working-directory: .
        run: |
          $gnArgs = @"
          is_debug=$(${{ matrix.config }} -eq 'Debug')
          is_official_build=$(${{ matrix.config }} -eq 'Release')
          target_os="windows"
          target_cpu="x64"
          is_component_build=false
          is_static_lib=true
          skia_enable_gpu=true
          skia_use_direct3d=true
          d3d11_enabled=true
          skia_use_system_libjpeg=false  # 优先用 Skia 内置依赖（避免版本冲突）
          skia_use_system_libpng=false
          skia_use_system_zlib=false
          skia_use_system_freetype2=false
          skia_use_system_harfbuzz=false
          skia_use_system_webp=false
          skia_enable_svg=true
          skia_enable_skottie=true
          skia_enable_skshaper=true
          skia_enable_paragraph=true
          skia_enable_effects=true
          skia_enable_filters=true
          optimize="$(${{ matrix.config }} -eq 'Release' ? 'speed' : 'none')"
          extra_cflags=["/MT$(${{ matrix.config }} -eq 'Debug' ? 'd' : '')"]
          "@
          ./third_party/gn/out/gn gen out/${{ matrix.config }} --args=$gnArgs

      # 5. Ninja 编译 Skia 静态库
      - name: Build Skia static lib
        working-directory: .
        run: |
          ninja -C out/${{ matrix.config }}

      # 6. 打包静态库 + 头文件
      - name: Package ${{ matrix.config }}
        working-directory: .
        run: |
          $outDir = "package/${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $skiaLib = Get-ChildItem -Path out/${{ matrix.config }} -Filter "skia.lib" -Recurse | Select-Object -First 1
          if ($skiaLib -eq $null) { throw "Cannot find skia static lib after build." }
          Copy-Item $skiaLib.FullName -Destination "$outDir/skia.lib" -ErrorAction Stop
          robocopy "include" "$outDir/include" /E /NP /NFL /NDL | Out-Null

      # 7. 上传产物
      - name: Upload Artifact ${{ matrix.config }}
        uses: actions/upload-artifact@v4
        with:
          name: skia-windows-x64-static-${{ matrix.config }}-m142
          path: package/${{ matrix.config }}
