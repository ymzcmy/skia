name: Build Skia m142 (Windows x64 static, LLVM)

on:
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]
  workflow_dispatch:

env:
  SKIA_VERSION: m142
  LLVM_URL: https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/LLVM-17.0.6-win64.exe
  DEPOT_TOOLS_URL: https://storage.googleapis.com/chrome-infra/depot_tools.zip
  GN_ARGS_BASE: |
    target_cpu="x64"
    is_official_build=true
    is_component_build=false
    is_debug=false
    clang_win="C:/Program Files/LLVM"
    cc="clang-cl"
    cxx="clang-cl"
    extra_cflags=["/MT"]   # Release 用 /MT，Debug 用 /MTd
    skia_use_system_libjpeg=true
    skia_use_system_libpng=true
    skia_use_system_zlib=true
    skia_use_system_freetype2=false
    skia_use_system_harfbuzz=false
    skia_use_system_webp=false
    skia_enable_svg=true
    skia_enable_skottie=true
    skia_enable_skshaper=true
    skia_enable_paragraph=true
    skia_enable_effects=true
    skia_enable_filters=true
    skia_use_expat=true
    skia_use_system_expat=false
    skia_use_icu=false
    skia_use_xps=false
    skia_enable_gpu=false
    skia_use_angle=false

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Release, Debug]
    steps:
      - name: Checkout Skia
        run: |
          git clone https://skia.googlesource.com/skia.git skia
          cd skia
          git checkout chrome/${{ env.SKIA_VERSION }}

      - name: Install Depot Tools (with update)
        run: |
          # 下载并解压 depot_tools
          curl -Lo depot_tools.zip ${{ env.DEPOT_TOOLS_URL }}
          7z x depot_tools.zip -o"C:\depot_tools" -y
          # 添加到 PATH（先添加，后续 LLVM 路径会覆盖工具冲突）
          echo "C:\depot_tools" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8
          # 更新 depot_tools 到最新版本（避免旧工具冲突）
          cd C:\depot_tools
          git pull

      - name: Install LLVM (silent install)
        run: |
          # 下载 LLVM 安装包
          curl -Lo llvm.exe ${{ env.LLVM_URL }}
          # 静默安装到指定目录（避免 7z 解压导致的文件结构异常）
          llvm.exe /S /D="C:\Program Files\LLVM"
          # 将 LLVM 二进制路径添加到 PATH（优先级高于 depot_tools）
          echo "C:\Program Files\LLVM\bin" | Out-File -Append -FilePath $env:GITHUB_PATH -Encoding utf8

      - name: Sync third-party dependencies (skip emsdk)
        working-directory: skia
        env:
          # 禁用 Emscripten 相关逻辑（避免触发 activate-emsdk 错误）
          NO_EMSCRIPTEN: 1
        run: |
          # 显式使用系统 Python 执行（避免 depot_tools 内置旧版本 Python 冲突）
          python tools/git-sync-deps --deps-target=win

      - name: Generate GN args
        shell: pwsh
        working-directory: skia
        run: |
          $args = "${{ env.GN_ARGS_BASE }}"
          if ("${{ matrix.config }}" -eq "Debug") {
            $args = $args.Replace('is_debug=false','is_debug=true')
                         .Replace('extra_cflags=["/MT"]','extra_cflags=["/MTd"]')
          }
          New-Item -ItemType Directory -Force -Path "out/${{ matrix.config }}"
          $args | Out-File -FilePath "out/${{ matrix.config }}/args.gn" -Encoding utf8

      - name: Generate build files with GN
        working-directory: skia
        run: gn gen out/${{ matrix.config }}

      - name: Build with Ninja
        working-directory: skia
        run: ninja -C out/${{ matrix.config }} skia

      - name: Collect artifacts
        shell: pwsh
        working-directory: skia
        run: |
          $dst = "${{ github.workspace }}/skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path "$dst/include"
          New-Item -ItemType Directory -Force -Path "$dst/lib"
          
          # 复制头文件（处理 robocopy 特殊退出码：≤7 均为成功）
          robocopy include "$dst/include" /E /NP /NFL /NDL
          if ($LASTEXITCODE -le 7) { exit 0 } else { exit $LASTEXITCODE }
          
          # 复制静态库、构建参数、许可证
          Copy-Item out/${{ matrix.config }}/*.lib "$dst/lib"
          Copy-Item out/${{ matrix.config }}/args.gn "$dst"
          Copy-Item LICENSE "$dst"
          
          # 打包为 zip
          7z a -tzip "${dst}.zip" "$dst/*"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}
          path: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip

      - name: Upload to Release (on tag push)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip
