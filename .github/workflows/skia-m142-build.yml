name: Build Skia m142 (Windows x64 Static, LLVM + vcpkg Static Libs)

on:
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]
  workflow_dispatch:

env:
  SKIA_VERSION: m142
  LLVM_URL: https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-win64.exe        
  DEPOT_TOOLS_URL: https://storage.googleapis.com/chrome-infra/depot_tools.zip        
  LLVM_PATH: C:/LLVM
  GN_ARGS_BASE: |
    target_cpu="x64"
    is_component_build=false
    clang_win="C:/LLVM"
    cc="clang-cl"
    cxx="clang-cl"
    
    # å¯ç”¨ç³»ç»Ÿé™æ€åº“ï¼ˆvcpkg æä¾›ï¼‰
    skia_use_system_libjpeg=true
    skia_use_libjpeg_turbo=true
    skia_use_system_libpng=true
    skia_use_system_zlib=true
    skia_use_system_webp=true
    skia_use_system_expat=true
    skia_use_system_freetype2=true
    
    # é¢œè‰²ç®¡ç†æ¨¡å—
    skia_use_skcms=true
    
    # æ–‡æœ¬å¤„ç†æ¨¡å—
    skia_use_harfbuzz=true
    skia_use_skunicode=true
    
    # æ ¸å¿ƒ 2D å›¾å½¢èƒ½åŠ›
    skia_enable_svg=true
    skia_enable_gpu=true
    skia_use_angle=true
    
    # æ–‡æœ¬æ¸²æŸ“
    skia_enable_paragraph=true
    skia_enable_skshaper=true
    skia_use_icu=true
    skia_use_system_icu=false
    
    # è§†è§‰æ•ˆæœ
    skia_enable_skottie=true
    skia_enable_effects=true
    skia_enable_filters=true
    
    # å†—ä½™åŠŸèƒ½è£å‰ª
    skia_use_xps=false
    skia_enable_pdf=false
    skia_enable_flutter_defines=false
    skia_enable_nvpr=false
    skia_enable_spirv_validation=false
    skia_use_dng_sdk=false
    skia_use_sfntly=false
    
    # ç¡®ä¿é“¾æ¥æ­£ç¡®çš„ CRT
    is_clang=true
    win_vc=""
    
  RELEASE_NAME: "Skia-m142-Nightly-Windows-Static"

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Release, Debug]
    steps:
      - name: Checkout Skia (from own repo)
        run: |
          git clone https://github.com/ymzcmy/skia.git         skia
          cd skia
          git checkout chrome/${{ env.SKIA_VERSION }}
          git submodule update --init --recursive

      - name: Install Depot Tools (with update)
        run: |
          curl -Lo depot_tools.zip ${{ env.DEPOT_TOOLS_URL }}
          7z x depot_tools.zip -o"C:\depot_tools" -y
          echo "C:\depot_tools" >> $env:GITHUB_PATH
          cd C:\depot_tools
          git checkout main
          git pull

      # ===== å®‰è£…æ‰€æœ‰ç³»ç»Ÿä¾èµ–åº“ï¼ˆé™æ€åº“ï¼‰=====
      - name: Install vcpkg and all static dependencies
        shell: pwsh
        run: |
          # å®‰è£… vcpkg
          Write-Host "ğŸ“¦ å®‰è£… vcpkg åŒ…ç®¡ç†å™¨..." -ForegroundColor Cyan
          git clone https://github.com/microsoft/vcpkg.git        
          .\vcpkg\bootstrap-vcpkg.bat
          
          # å®‰è£…æ‰€æœ‰éœ€è¦çš„é™æ€åº“ (ä½¿ç”¨ x64-windows-static triplet)
          Write-Host "ğŸ”§ å®‰è£…æ‰€æœ‰é™æ€ä¾èµ–åº“..." -ForegroundColor Cyan
          .\vcpkg\vcpkg.exe install `
            libjpeg-turbo:x64-windows-static `
            libpng:x64-windows-static `
            zlib:x64-windows-static `
            libwebp:x64-windows-static `
            expat:x64-windows-static `
            freetype:x64-windows-static `
            icu:x64-windows-static `
            harfbuzz:x64-windows-static
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          $vcpkgRoot = (Get-Location).Path + "\vcpkg"
          $vcpkgTriplet = "x64-windows-static"
          
          # è®¾ç½®å…¨å±€ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿åç»­æ­¥éª¤å¯è®¿é—®
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKG_TRIPLET=$vcpkgTriplet" >> $env:GITHUB_ENV
          
          # è®¾ç½® PATH (é‡è¦: ç¡®ä¿ vcpkg åœ¨ PATH ä¸­)
          echo "$vcpkgRoot" >> $env:GITHUB_PATH
          echo "$vcpkgRoot\installed\$vcpkgTriplet\bin" >> $env:GITHUB_PATH
          
          Write-Host "âœ… vcpkg é™æ€åº“å®‰è£…æˆåŠŸ!"

      - name: Initialize depot_tools
        run: |
          cd C:\depot_tools
          echo "solutions = []" > .gclient
          gclient
          del .gclient

      - name: Install LLVM (silent install)
        shell: pwsh
        run: |
          $installPath = "C:\LLVM"
          
          if (-not (Test-Path $installPath)) {
            New-Item -ItemType Directory -Path $installPath -Force | Out-Null
          }
          
          $llvmExe = Join-Path $env:TEMP "llvm.exe"
          Invoke-WebRequest -Uri ${{ env.LLVM_URL }} -OutFile $llvmExe
          
          $installArgs = "/S", "/D=$installPath"
          $proc = Start-Process -FilePath $llvmExe -ArgumentList $installArgs -Wait -PassThru -NoNewWindow
          
          if ($proc.ExitCode -ne 0) {
            Write-Error "LLVM å®‰è£…å¤±è´¥! é€€å‡ºç : $($proc.ExitCode)"
            exit 1
          }
          
          $clangPath = Join-Path $installPath "bin\clang-cl.exe"
          if (-not (Test-Path $clangPath)) {
            $llvmDir = Get-ChildItem -Path $installPath -Directory | Select-Object -First 1
            if ($llvmDir) {
              $clangPath = Join-Path $llvmDir.FullName "bin\clang-cl.exe"
              $installPath = $llvmDir.FullName
            }
          }
          
          if (-not (Test-Path $clangPath)) {
            Write-Error "clang-cl.exe ä¸å­˜åœ¨!"
            exit 1
          }
          
          $env:Path += ";$installPath\bin"
          [System.Environment]::SetEnvironmentVariable("Path", $env:Path, "Machine")
          Write-Host "clang-cl version:"
          clang-cl --version

      - name: åˆ›å»º emsdk é˜²å¾¡è„šæœ¬
        shell: pwsh
        working-directory: skia
        run: |
          $binPath = Join-Path -Path $pwd -ChildPath "bin"
          if (-not (Test-Path $binPath)) {
            New-Item -ItemType Directory -Path $binPath -Force | Out-Null
            Write-Host "ğŸ“ åˆ›å»º bin ç›®å½•: $binPath"
          }
          
          # åˆ›å»ºé˜²å¾¡æ€§è„šæœ¬
          $pyContent = "import sys`r`nsys.exit(0)"
          $pyPath = Join-Path $binPath "activate-emsdk"
          [System.IO.File]::WriteAllText($pyPath, $pyContent)
          
          $batContent = "@echo off`r`nexit /b 0"
          $batPath = Join-Path $binPath "activate-emsdk.bat"
          [System.IO.File]::WriteAllText($batPath, $batContent)
          
          $ps1Content = "exit 0"
          $ps1Path = Join-Path $binPath "activate-emsdk.ps1"
          [System.IO.File]::WriteAllText($ps1Path, $ps1Content)
          
          Write-Host "âœ… åˆ›å»º emsdk é˜²å¾¡è„šæœ¬"
          [Environment]::SetEnvironmentVariable("NO_EMSCRIPTEN", "1", "Process")

      - name: åŒæ­¥ç¬¬ä¸‰æ–¹ä¾èµ–
        working-directory: skia
        shell: pwsh
        run: |
          $python = "C:\hostedtoolcache\windows\Python\3.9.13\x64\python.exe"
          if (-not (Test-Path $python)) {
            Write-Error "Python æœªæ‰¾åˆ°!"
            exit 1
          }
          
          & $python tools\git-sync-deps --deps-target=win --no-emsdk
          if ($LASTEXITCODE -ne 0) {
            Write-Error "ä¾èµ–åŒæ­¥å¤±è´¥! é€€å‡ºç : $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          Write-Host "âœ… ä¾èµ–åŒæ­¥æˆåŠŸ"

      - name: ç”Ÿæˆ GN æ„å»ºå‚æ•°
        shell: pwsh
        working-directory: skia
        run: |
          # ä»ç¯å¢ƒå˜é‡è·å– vcpkg è·¯å¾„
          $vcpkgRoot = $env:VCPKG_ROOT
          $vcpkgTriplet = $env:VCPKG_TRIPLET
          $vcpkgInclude = Join-Path $vcpkgRoot "installed\$vcpkgTriplet\include"
          $vcpkgLib = Join-Path $vcpkgRoot "installed\$vcpkgTriplet\lib"
          
          if (-not (Test-Path $vcpkgInclude)) {
            Write-Error "vcpkg å¤´æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨: $vcpkgInclude"
            exit 1
          }
          
          $gnArgs = $env:GN_ARGS_BASE
          
          # æ·»åŠ  vcpkg è·¯å¾„å’Œé¢å¤–ç¼–è¯‘/é“¾æ¥æ ‡å¿—
          $gnArgs += "`n`nvcpkg_root_dir=`"$vcpkgRoot`"`n"
          $gnArgs += "`nvcpkg_triplet=`"$vcpkgTriplet`"`n"
          
          $gnArgs += "`nextra_cflags = ["
          $gnArgs += "`"-I$vcpkgInclude`", "
          $gnArgs += "`"-I$vcpkgInclude/freetype2`""
          $gnArgs += "`n]`n"
          
          $gnArgs += "`nextra_ldflags = ["
          $gnArgs += "`"-LIBPATH:$vcpkgLib`""
          $gnArgs += "`n]`n"
          
          # å¯ç”¨å…¨é™æ€é“¾æ¥
          $gnArgs += "`nall_deps_as_static_libs=true`n"
          
          # è®¾ç½®æ­£ç¡®çš„ CRT é“¾æ¥
          if ("${{ matrix.config }}" -eq "Debug") {
            $gnArgs += "`nis_debug=true`n"
            $gnArgs += "`nis_official_build=false`n"
            $gnArgs += "`nextra_cflags += [`"/MTd`"]`n"
          } else {
            $gnArgs += "`nis_debug=false`n"
            $gnArgs += "`nis_official_build=true`n"
            $gnArgs += "`nextra_cflags += [`"/MT`"]`n"
          }
          
          $outDir = "out\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          
          $argsPath = Join-Path -Path $outDir -ChildPath "args.gn"
          [System.IO.File]::WriteAllText($argsPath, $gnArgs)
          Write-Host "âœ… GN å‚æ•°å·²ç”Ÿæˆ: $argsPath"

      - name: ç”¨ GN ç”Ÿæˆæ„å»ºæ–‡ä»¶
        working-directory: skia
        run: |
          Write-Host "ğŸ”§ ç”¨ GN ç”Ÿæˆæ„å»ºæ–‡ä»¶..."
          gn gen "out/${{ matrix.config }}"

      - name: ç”¨ Ninja ç¼–è¯‘
        working-directory: skia
        run: ninja -C "out/${{ matrix.config }}" skia

      - name: æ”¶é›†æ„å»ºäº§ç‰©
        shell: pwsh
        working-directory: skia
        run: |
          $config = "${{ matrix.config }}"
          $dst = "${{ github.workspace }}\skia-${{ env.SKIA_VERSION }}-windows-x64-static-${config}"
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          New-Item -Path "$dst\include" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\lib" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\modules" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\third_party" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\deps" -ItemType Directory -Force | Out-Null
          
          # å¤åˆ¶ Skia ä¸»è¦å¤´æ–‡ä»¶
          Write-Host "ğŸ“¦ å¤åˆ¶ Skia ä¸»è¦å¤´æ–‡ä»¶åˆ° $dst\include..."
          robocopy "include" "$dst\include" /E /R:1 /W:1
          if ($LASTEXITCODE -gt 7) {
            Write-Error "âŒ ä¸»è¦å¤´æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼é€€å‡ºç : $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          # å¤åˆ¶æ¨¡å—å¤´æ–‡ä»¶
          $requiredModules = @("skcms", "skparagraph", "skshaper", "skottie", "svg", "particles")
          foreach ($module in $requiredModules) {
            $srcPath = "modules/$module"
            if (Test-Path $srcPath) {
              $dstModulePath = "$dst\modules\$module"
              New-Item -Path $dstModulePath -ItemType Directory -Force | Out-Null
              Write-Host "ğŸ“¦ å¤åˆ¶ $module æ¨¡å—å¤´æ–‡ä»¶åˆ° $dstModulePath..."
              robocopy $srcPath $dstModulePath /E /XF "*.cpp" "*.cc" "*.c" "*.bat" "*.py" "*.md" "*.txt" "*.gitignore" "*.json" "*.cmake" /R:1 /W:1
              if ($LASTEXITCODE -gt 7) {
                Write-Warning "$module æ¨¡å—å¤åˆ¶è­¦å‘Šï¼é€€å‡ºç : $LASTEXITCODE"
              }
            }
          }
          
          # å¤åˆ¶å¿…è¦çš„ç¬¬ä¸‰æ–¹å¤´æ–‡ä»¶
          $thirdPartyDirs = @("icu", "dawn")
          foreach ($dir in $thirdPartyDirs) {
            $srcPath = "third_party/$dir"
            if (Test-Path $srcPath) {
              $dstPath = "$dst\third_party\$dir"
              New-Item -Path $dstPath -ItemType Directory -Force | Out-Null
              Write-Host "ğŸ“¦ å¤åˆ¶ third_party/$dir å¤´æ–‡ä»¶åˆ° $dstPath..."
              robocopy $srcPath $dstPath /E /XF "*.cpp" "*.cc" "*.c" "*.bat" "*.py" "*.md" "*.txt" "*.gitignore" "*.json" "*.cmake" /R:1 /W:1
              if ($LASTEXITCODE -gt 7) {
                Write-Warning "third_party/$dir å¤åˆ¶è­¦å‘Šï¼é€€å‡ºç : $LASTEXITCODE"
              }
            }
          }
          
          # ğŸš€ å…³é”®ä¿®å¤ï¼šå¤åˆ¶ vcpkg å®‰è£…çš„ç¬¬ä¸‰æ–¹åº“å¤´æ–‡ä»¶
          Write-Host "ğŸ”§ å¤åˆ¶ vcpkg å®‰è£…çš„ç¬¬ä¸‰æ–¹åº“å¤´æ–‡ä»¶..."
          $vcpkgRoot = $env:VCPKG_ROOT
          $vcpkgTriplet = $env:VCPKG_TRIPLET
          $vcpkgIncludeDir = Join-Path $vcpkgRoot "installed\$vcpkgTriplet\include"
          
          # åˆ›å»º deps/include ç›®å½•æ¥å­˜æ”¾ç¬¬ä¸‰æ–¹å¤´æ–‡ä»¶
          $depsIncludeDir = "$dst\deps\include"
          New-Item -Path $depsIncludeDir -ItemType Directory -Force | Out-Null
          
          # å¤åˆ¶æ‰€æœ‰ vcpkg å®‰è£…çš„å¤´æ–‡ä»¶
          Write-Host "  å¤åˆ¶ vcpkg æ‰€æœ‰å¤´æ–‡ä»¶åˆ° $depsIncludeDir..."
          robocopy $vcpkgIncludeDir $depsIncludeDir /E /XF "*.cmake" "*.pc" "*.la" "*.a" "*.lib" "*.dll" "*.exe" "*.bat" "*.py" /R:1 /W:1
          if ($LASTEXITCODE -gt 7) {
            Write-Warning "vcpkg å¤´æ–‡ä»¶å¤åˆ¶è­¦å‘Šï¼é€€å‡ºç : $LASTEXITCODE"
          }
          
          # ç‰¹åˆ«å¤„ç† freetype2 å¤´æ–‡ä»¶ (é€šå¸¸éœ€è¦ç‰¹æ®Šç›®å½•ç»“æ„)
          $freetypeInclude = Join-Path $vcpkgIncludeDir "freetype2"
          if (Test-Path $freetypeInclude) {
            $freetypeDest = "$depsIncludeDir\freetype2"
            New-Item -Path $freetypeDest -ItemType Directory -Force | Out-Null
            robocopy $freetypeInclude $freetypeDest /E /R:1 /W:1
          }
          
          # å¤åˆ¶ Skia åº“æ–‡ä»¶
          Write-Host "ğŸ“¦ å¤åˆ¶ Skia åº“æ–‡ä»¶..."
          Copy-Item "out\${config}\*.lib" -Destination "$dst\lib" -Force
          
          # å¤åˆ¶ vcpkg å®‰è£…çš„ç¬¬ä¸‰æ–¹é™æ€åº“
          Write-Host "ğŸ”§ å¤åˆ¶ vcpkg å®‰è£…çš„ç¬¬ä¸‰æ–¹é™æ€åº“..."
          $vcpkgLibDir = Join-Path $vcpkgRoot "installed\$vcpkgTriplet\lib"
          
          # å¤åˆ¶ debug æˆ– release ç‰ˆæœ¬çš„åº“
          $suffix = if ($config -eq "Debug") { "d" } else { "" }
          
          # å®šä¹‰éœ€è¦å¤åˆ¶çš„åº“
          $requiredLibs = @(
            "*png*${suffix}.lib", "*zlib*${suffix}.lib", "*jpeg*${suffix}.lib", "*webp*${suffix}.lib", 
            "*expat*${suffix}.lib", "*freetype*${suffix}.lib", "*icu*${suffix}.lib", "*harfbuzz*${suffix}.lib"
          )
          
          foreach ($lib in $requiredLibs) {
            $libFiles = Get-ChildItem -Path $vcpkgLibDir -Include $lib -Recurse
            foreach ($file in $libFiles) {
              Copy-Item $file.FullName -Destination "$dst\lib\" -Force
              Write-Host "  âœ… å¤åˆ¶: $($file.Name)"
            }
          }
          
          # å¤åˆ¶æ„å»ºé…ç½®å’Œè®¸å¯è¯
          Write-Host "ğŸ“¦ å¤åˆ¶æ„å»ºé…ç½®..."
          Copy-Item "out\${config}\args.gn" -Destination "$dst" -Force
          Write-Host "ğŸ“¦ å¤åˆ¶è®¸å¯è¯..."
          Copy-Item "LICENSE" -Destination "$dst" -Force
          
          # å‹ç¼©äº§ç‰©
          $zipPath = "${{ github.workspace }}\skia-m142-windows-x64-static-$config.zip"
          Write-Host "ğŸ“¦ å‹ç¼©äº§ç‰©åˆ° $zipPath..."
          Compress-Archive -Path "$dst\*" -DestinationPath $zipPath -Force
          
          if (Test-Path $zipPath) {
            $sizeMB = [math]::Round((Get-Item $zipPath).Length / 1MB, 2)
            Write-Host "âœ… äº§ç‰©å·²æ‰“åŒ…: $zipPath (å¤§å°: $sizeMB MB)"
          } else {
            Write-Error "âŒ äº§ç‰©å‹ç¼©æ–‡ä»¶ä¸å­˜åœ¨: $zipPath"
            exit 1
          }
          
          exit 0

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ env.SKIA_VERSION }}-windows-x64-static-${{ matrix.config }}
          path: ${{ github.workspace }}/skia-m142-windows-x64-static-${{ matrix.config }}.zip

      - name: ä¸Šä¼ åˆ° Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/chrome/m142'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: m142-windows-x64-release
          name: ${{ env.RELEASE_NAME }}
          prerelease: false
          body: |
            **Skia m142 è‡ªåŠ¨æ„å»º (Windows x64 é™æ€åº“)**
            
            Skia æ˜¯ä¸€ä¸ªå®Œæ•´çš„ 2D å›¾å½¢åº“ï¼Œç”¨äºç»˜åˆ¶**æ–‡æœ¬**ã€**å‡ ä½•å›¾å½¢**å’Œ**å›¾åƒ**ã€‚
            
            **æ„å»ºè¯¦æƒ…**:
            - åˆ†æ”¯: `${{ github.ref_name }}`  
            - æäº¤: `${{ github.sha }}`  
            - é…ç½®: `${{ matrix.config }}`  
            - æ ¸å¿ƒåŠŸèƒ½:
              - GPU åŠ é€Ÿæ¸²æŸ“ (ANGLE)
              - SVG çŸ¢é‡å›¾å½¢
              - é«˜çº§æ–‡æœ¬æ’ç‰ˆ
              - åŠ¨ç”»æ”¯æŒ (Skottie)
              - é¢œè‰²ç®¡ç† (SkCMS)
            - é™æ€ä¾èµ–åº“:
              - libjpeg-turbo (é™æ€)
              - libpng (é™æ€)
              - zlib (é™æ€)
              - libwebp (é™æ€)
              - expat (é™æ€)
              - freetype (é™æ€)
              - ICU (é™æ€)
              - HarfBuzz (é™æ€)
            
            **åŒ…å«å†…å®¹**:
            - Skia ä¸»è¦å¤´æ–‡ä»¶ (`include/`)
            - æ¨¡å—å¤´æ–‡ä»¶ (`modules/`)
            - ç¬¬ä¸‰æ–¹åº“å¤´æ–‡ä»¶ (`deps/include/`)
            - æ‰€æœ‰é™æ€åº“æ–‡ä»¶ (`lib/`)
            
            > æ­¤æ„å»ºé’ˆå¯¹ Windows x64 å¹³å°ï¼Œä½¿ç”¨ vcpkg å®‰è£…æ‰€æœ‰ä¾èµ–å¹¶å®Œå…¨é™æ€é“¾æ¥
          overwrite: true
          files: |
            ${{ github.workspace }}/skia-m142-windows-x64-static-Release.zip
            ${{ github.workspace }}/skia-m142-windows-x64-static-Debug.zip
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
