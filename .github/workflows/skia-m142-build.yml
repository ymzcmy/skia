name: Skia Static Build (Windows x64 Debug & Release, chrome/m142, UI Advanced, No DLL)

on:
  workflow_dispatch:
    inputs:
      skia_branch:
        description: 'Skia branch to build (e.g., chrome/m142)'
        required: false
        default: 'chrome/m142'
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]

jobs:
  build-windows:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Debug, Release]
      fail-fast: false

    steps:
      - name: Checkout Skia source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.skia_branch || 'chrome/m142' }}
          submodules: recursive
          fetch-depth: 0
          clean: true

      # 修复点1: 直接使用预装的 VS 2022 (无需安装)
      - name: Setup Visual Studio Environment
        shell: powershell
        run: |
          # GitHub Actions windows-2022 环境已预装 VS 2022
          $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build"
          if (-not (Test-Path $vsPath)) {
            Write-Error "VS 2022 not found at $vsPath. Expected in windows-2022 image."
            exit 1
          }
          
          # 添加到 PATH (GitHub Actions 特定方式)
          Write-Host "##[add-path]$vsPath"
          $env:PATH = "$vsPath;$env:PATH"
          
          # 验证关键工具存在
          if (-not (Get-Command vcvarsall.bat -ErrorAction SilentlyContinue)) {
            Write-Error "vcvarsall.bat not found in PATH"
            exit 1
          }

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Ninja
        run: pip install ninja
        shell: cmd

      - name: Build GN Tool
        working-directory: third_party\gn
        shell: cmd
        run: |
          python build/gen.py --no-last-commit-position
          ninja -C out

      - name: Verify GN
        run: third_party\gn\out\gn --version
        shell: cmd

      - name: Configure GN Args (${{ matrix.config }})
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $isDebug = $config -eq "Debug"
          $optimize = if ($isDebug) { "none" } else { "speed" }
          $runtime = if ($isDebug) { "/MTd" } else { "/MT" }
          
          $gnArgs = @"
          is_debug=$isDebug
          is_official_build=$(!$isDebug)
          target_os="windows"
          target_cpu="x64"
          is_component_build=false
          is_static_lib=true
          skia_enable_gpu=true
          skia_use_direct3d=true
          d3d11_enabled=true
          skia_use_system_libjpeg=false
          skia_use_system_libpng=false
          skia_use_system_zlib=false
          skia_use_system_freetype2=false
          skia_use_system_harfbuzz=false
          skia_use_system_webp=false
          skia_enable_svg=true
          skia_enable_skottie=true
          skia_enable_skshaper=true
          skia_enable_paragraph=true
          skia_enable_effects=true
          skia_enable_filters=true
          optimize="$optimize"
          extra_cflags=["$runtime"]
          win_sdk_version="10.0.22621.0"
          "@
          
          ./third_party/gn/out/gn.exe gen out/$config --args=$gnArgs

      - name: Build Skia static lib (${{ matrix.config }})
        shell: cmd
        run: |
          call vcvarsall.bat amd64
          ninja -C out/${{ matrix.config }} -j 4
        timeout-minutes: 60

      - name: Verify Build Outputs (${{ matrix.config }})
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $libPath = "out/$config/skia.lib"
          
          if (-not (Test-Path $libPath)) {
            Write-Error "skia.lib not found at $libPath"
            Get-ChildItem out/$config -Recurse | Format-List
            exit 1
          }
          Write-Host "✅ Found skia.lib at $libPath"

      - name: Package ${{ matrix.config }}
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $outDir = "package/$config"
          $libPath = "out/$config/skia.lib"
          
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          Copy-Item $libPath -Destination "$outDir/skia.lib"
          robocopy "include" "$outDir/include" /E /NJH /NJS /NFL /NDL | Out-Null
          
          "Skia chrome/m142 static build" | Out-File "$outDir/VERSION.txt"
          "Config: $config" | Out-File -Append "$outDir/VERSION.txt"
          Get-Date -Format "yyyy-MM-dd HH:mm" | Out-File -Append "$outDir/VERSION.txt"

      - name: Upload Artifact ${{ matrix.config }}
        uses: actions/upload-artifact@v4
        with:
          name: skia-windows-x64-static-${{ matrix.config }}-m142
          path: package/${{ matrix.config }}
          retention-days: 30
