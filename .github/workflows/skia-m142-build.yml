name: Build Skia m142 (Windows x64 static, LLVM)

on:
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]
  workflow_dispatch:

env:
  SKIA_VERSION: m142
  LLVM_URL: https://github.com/llvm/llvm-project/releases/download/llvmorg-17.0.6/LLVM-17.0.6-win64.exe
  DEPOT_TOOLS_URL: https://storage.googleapis.com/chrome-infra/depot_tools.zip
  GN_ARGS_BASE: |
    target_cpu="x64"
    is_official_build=true
    is_component_build=false
    is_debug=false
    clang_win="C:/Program Files/LLVM"
    cc="clang-cl"
    cxx="clang-cl"
    extra_cflags=["/MT"]   # Release ç”¨ /MTï¼ŒDebug ç”¨ /MTd
    skia_use_system_libjpeg=true
    skia_use_system_libpng=true
    skia_use_system_zlib=true
    skia_use_system_freetype2=false
    skia_use_system_harfbuzz=false
    skia_use_system_webp=false
    skia_enable_svg=true
    skia_enable_skottie=true
    skia_enable_skshaper=true
    skia_enable_paragraph=true
    skia_enable_effects=true
    skia_enable_filters=true
    skia_use_expat=true
    skia_use_system_expat=false
    skia_use_icu=false
    skia_use_xps=false
    skia_enable_gpu=false
    skia_use_angle=false
  RELEASE_NAME: "Skia-m142-Nightly-Windows"

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Release, Debug]
    steps:
      - name: Checkout Skia (from own repo)
        run: |
          git clone https://github.com/ymzcmy/skia.git skia
          cd skia
          git checkout chrome/${{ env.SKIA_VERSION }}

      - name: Install Depot Tools (with update)
        run: |
          curl -Lo depot_tools.zip ${{ env.DEPOT_TOOLS_URL }}
          7z x depot_tools.zip -o"C:\depot_tools" -y
          echo "C:\depot_tools" >> $env:GITHUB_PATH
          cd C:\depot_tools
          git checkout main
          git pull

      - name: Install LLVM (silent install)
        run: |
          curl -Lo llvm.exe ${{ env.LLVM_URL }}
          ./llvm.exe /S /D="C:\Program Files\LLVM"
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
          clang-cl --version

      # ===== 100% å¯é çš„é˜²å¾¡è„šæœ¬åˆ›å»º =====
      - name: åˆ›å»ºç»å¯¹å¯é çš„ emsdk é˜²å¾¡æœºåˆ¶
        shell: pwsh
        working-directory: skia
        run: |
          # 1. ç¡®ä¿ bin ç›®å½•å­˜åœ¨
          $binPath = Join-Path -Path $pwd -ChildPath "bin"
          if (-not (Test-Path $binPath)) {
            New-Item -ItemType Directory -Path $binPath -Force | Out-Null
            Write-Host "ðŸ“ åˆ›å»ºç›®å½•: $binPath"
          }
          
          # 2. åˆ›å»ºé˜²å¾¡è„šæœ¬ (ç¡®ä¿ Windows èƒ½æ­£ç¡®æ‰§è¡Œ)
          $scripts = @(
            # æ— æ‰©å±•å (å®žé™…æ˜¯æ‰¹å¤„ç†å†…å®¹)
            @{Name = "activate-emsdk"; 
              Content = "@echo off`r`nexit /b 0"; 
              Encoding = "ASCII"},
            
            # .bat ç‰ˆæœ¬ (Windows ä¼˜å…ˆ)
            @{Name = "activate-emsdk.bat"; 
              Content = "@echo off`r`nexit /b 0"; 
              Encoding = "ASCII"},
            
            # .ps1 ç‰ˆæœ¬ (ä½œä¸ºåŽå¤‡)
            @{Name = "activate-emsdk.ps1"; 
              Content = "exit 0"; 
              Encoding = "UTF8"}
          )
          
          foreach ($script in $scripts) {
            $scriptPath = Join-Path -Path $binPath -ChildPath $script.Name
            
            # å†™å…¥æ–‡ä»¶ï¼ˆç‰¹æ®Šå¤„ç†æ¢è¡Œç¬¦ï¼‰
            $script.Content | Out-File -FilePath $scriptPath -Encoding $script.Encoding -Force
            
            # è®¾ç½®æ–‡ä»¶å±žæ€§
            attrib -R $scriptPath 2>$null
            
            Write-Host "ðŸ›¡ï¸ åˆ›å»º: $scriptPath"
            Write-Host "   å†…å®¹: '$($script.Content -replace '`r','\\r' -replace '`n','\\n')'"
            
            # éªŒè¯æ–‡ä»¶å†…å®¹
            $content = Get-Content $scriptPath -Raw
            Write-Host "   éªŒè¯å†…å®¹: '$($content.Trim() -replace '`r','\\r' -replace '`n','\\n')'"
          }
          
          # 3. éªŒè¯è„šæœ¬å¯æ‰§è¡Œæ€§
          Write-Host "`nðŸ” éªŒè¯é˜²å¾¡è„šæœ¬æ‰§è¡Œ:"
          
          # æµ‹è¯•æ— æ‰©å±•åè„šæœ¬
          cmd /c "bin\activate-emsdk"
          $exitCode = $LASTEXITCODE
          Write-Host "   æ— æ‰©å±•åè„šæœ¬: é€€å‡ºç  $exitCode"
          if ($exitCode -ne 0) {
            Write-Warning "âš ï¸ æ— æ‰©å±•åè„šæœ¬æœªè¿”å›ž 0ï¼Œä½†å°†ç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•"
          }
          
          # æµ‹è¯• .bat è„šæœ¬
          cmd /c "bin\activate-emsdk.bat"
          $exitCode = $LASTEXITCODE
          Write-Host "   .bat è„šæœ¬: é€€å‡ºç  $exitCode"
          
          # æµ‹è¯• .ps1 è„šæœ¬
          powershell -ExecutionPolicy Bypass -Command "bin\activate-emsdk.ps1; exit $LASTEXITCODE"
          $exitCode = $LASTEXITCODE
          Write-Host "   .ps1 è„šæœ¬: é€€å‡ºç  $exitCode"
          
          # 4. è®¾ç½®çŽ¯å¢ƒå˜é‡
          $env:NO_EMSCRIPTEN = "1"
          [Environment]::SetEnvironmentVariable("NO_EMSCRIPTEN", "1", "Process")
          Write-Host "`nâœ… NO_EMSCRIPTEN=1 (çŽ¯å¢ƒå˜é‡è®¾ç½®)"

      # ===== 100% å¯é çš„åŒæ­¥æ­¥éª¤ =====
      - name: åŒæ­¥ç¬¬ä¸‰æ–¹ä¾èµ– (æœ€ç»ˆç¡®è®¤)
        working-directory: skia
        shell: pwsh
        run: |
          # ç¡®è®¤çŽ¯å¢ƒå˜é‡
          Write-Host "çŽ¯å¢ƒå˜é‡éªŒè¯:"
          Write-Host "NO_EMSCRIPTEN = $env:NO_EMSCRIPTEN"
          
          # ä½¿ç”¨ç»å¯¹è·¯å¾„è°ƒç”¨ Python
          $python = "C:\hostedtoolcache\windows\Python\3.9.13\x64\python.exe"
          if (-not (Test-Path $python)) {
            Write-Error "âŒ Python æœªæ‰¾åˆ°! è·¯å¾„: $python"
            exit 1
          }
          
          # æ‰§è¡ŒåŒæ­¥å‘½ä»¤ (æ·»åŠ  --no-emsdk å‚æ•°)
          $cmd = "$python tools\git-sync-deps --deps-target=win --no-emsdk"
          Write-Host "`nâž¡ï¸ æ‰§è¡Œå‘½ä»¤: $cmd"
          
          # ä½¿ç”¨ cmd.exe æ‰§è¡Œï¼Œæ•èŽ·å®Œæ•´è¾“å‡º
          $process = Start-Process -FilePath "cmd.exe" -ArgumentList "/c", $cmd -Wait -PassThru -NoNewWindow -RedirectStandardOutput "sync_output.txt" -RedirectStandardError "sync_error.txt"
          
          # æ˜¾ç¤ºè¾“å‡º
          Write-Host "`nå‘½ä»¤è¾“å‡º:"
          Get-Content "sync_output.txt" | ForEach-Object { Write-Host "OUT: $_" }
          
          Write-Host "`né”™è¯¯è¾“å‡º:"
          if (Test-Path "sync_error.txt") {
            Get-Content "sync_error.txt" | ForEach-Object { Write-Host "ERR: $_" }
          }
          
          if ($process.ExitCode -ne 0) {
            Write-Error "`nâŒ ä¾èµ–åŒæ­¥å¤±è´¥! é€€å‡ºç : $($process.ExitCode)"
            
            # å°è¯•è¯Šæ–­å¤±è´¥åŽŸå› 
            Write-Host "`nðŸ” è¯Šæ–­ä¿¡æ¯:"
            Write-Host "å½“å‰ç›®å½•: $(pwd)"
            Write-Host "bin ç›®å½•å†…å®¹:"
            Get-ChildItem "bin" -Filter "activate-emsdk*" | ForEach-Object {
              Write-Host "  $($_.Name) - å¤§å°: $($_.Length) å­—èŠ‚"
            }
            
            exit $process.ExitCode
          }
          else {
            Write-Host "`nâœ… ä¾èµ–åŒæ­¥æˆåŠŸ!" -ForegroundColor Green
          }

      - name: ç”Ÿæˆ GN æž„å»ºå‚æ•°
        shell: pwsh
        working-directory: skia
        run: |
          $args = "${{ env.GN_ARGS_BASE }}"
          if ("${{ matrix.config }}" -eq "Debug") {
            $args = $args.Replace('is_debug=false', 'is_debug=true')
                         .Replace('extra_cflags=["/MT"]', 'extra_cflags=["/MTd"]')
          }
          $outDir = "out\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $args | Out-File -FilePath "${outDir}\args.gn" -Encoding utf8
          Write-Host "å·²ç”Ÿæˆ GN å‚æ•°: ${outDir}\args.gn"
          Get-Content "${outDir}\args.gn"

      - name: ç”¨ GN ç”Ÿæˆæž„å»ºæ–‡ä»¶
        working-directory: skia
        run: gn gen "out/${{ matrix.config }}"

      - name: ç”¨ Ninja ç¼–è¯‘
        working-directory: skia
        run: ninja -C "out/${{ matrix.config }}" skia

      - name: æ”¶é›†æž„å»ºäº§ç‰©
        shell: pwsh
        working-directory: skia
        run: |
          $config = "${{ matrix.config }}"
          $dst = "${{ github.workspace }}\skia-${{ env.SKIA_VERSION }}-windows-x64-${config}"
          
          # åˆ›å»ºç›®å½•ç»“æž„
          New-Item -Path "$dst\include" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\lib" -ItemType Directory -Force | Out-Null
          
          # å¤åˆ¶å¤´æ–‡ä»¶
          robocopy "include" "$dst\include" /E /NP /NFL /NDL /R:1 /W:1
          if ($LASTEXITCODE -gt 7) { 
            Write-Error "å¤´æ–‡ä»¶å¤åˆ¶å¤±è´¥ (é”™è¯¯ç : $LASTEXITCODE)"; exit $LASTEXITCODE 
          }
          
          # å¤åˆ¶åº“æ–‡ä»¶å’Œå…ƒæ•°æ®
          $libFiles = Get-ChildItem -Path "out\${config}\*.lib" -Recurse
          foreach ($file in $libFiles) {
            Copy-Item $file.FullName -Destination "$dst\lib" -Force
            Write-Host "ðŸ“„ å·²å¤åˆ¶: $($file.Name)"
          }
          
          Copy-Item "out\${config}\args.gn" -Destination "$dst" -Force
          Copy-Item "LICENSE" -Destination "$dst" -Force
          
          # åˆ›å»º ZIP å½’æ¡£
          Compress-Archive -Path "$dst\*" -DestinationPath "${dst}.zip" -Force
          $zipSize = (Get-Item "${dst}.zip").Length / 1MB
          Write-Host "ðŸ“¦ äº§ç‰©å·²æ‰“åŒ…: ${dst}.zip (å¤§å°: $($zipSize.ToString('F2')) MB)"

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}
          path: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip

      # ===== æ¯æ¬¡æˆåŠŸæž„å»ºåŽè¦†ç›–æ›´æ–°å›ºå®š Release =====
      - name: ä¸Šä¼ åˆ°å›ºå®š Release (è¦†ç›–æ›´æ–°)
        # ä»…åœ¨ main åˆ†æ”¯çš„ push äº‹ä»¶æˆ–æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ 
        if: (github.event_name == 'push' && github.ref == 'refs/heads/chrome/m142') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          # æŒ‡å®šå›ºå®š Release åç§° (ä¼šè¦†ç›–åŒå Release)
          name: ${{ env.RELEASE_NAME }}
          # è¦†ç›–æ›´æ–°å·²æœ‰ Release
          update: true
          # é™„åŠ æž„å»ºä¿¡æ¯
          body: |
            **è‡ªåŠ¨æž„å»ºäº§ç‰©**  
            - åˆ†æ”¯: `${{ github.ref_name }}`  
            - æäº¤: `${{ github.sha }}`  
            - æž„å»ºæ—¶é—´: `${{ github.event.head_commit.timestamp }}`  
            - é…ç½®: `${{ matrix.config }}`  
            - Skia ç‰ˆæœ¬: `${{ env.SKIA_VERSION }}`  
            - GitHub Runner: `${{ runner.os }}-${{ runner.arch }}`  
            
            > æ³¨: æ­¤ Release ä¼šè¢«æ–°æž„å»ºè¦†ç›–æ›´æ–°
          files: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
