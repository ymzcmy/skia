name: Skia Static Build (Windows x64 Debug & Release, chrome/m142, UI Advanced, No DLL)

on:
  workflow_dispatch:
    inputs:
      skia_branch:
        description: 'Skia branch to build (e.g., chrome/m142)'
        required: false
        default: 'chrome/m142'
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]

jobs:
  build-windows:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Debug, Release]
      fail-fast: false

    steps:
      # 1. 准备工作目录
      - name: Prepare workspace
        run: |
          mkdir skia_build
          cd skia_build
          echo "WORKSPACE=$(pwd)" >> $env:GITHUB_ENV
        shell: powershell

      # 2. 拉取skia_compile工具库
      - name: Checkout skia_compile
        working-directory: ${{ env.WORKSPACE }}
        uses: actions/checkout@v4
        with:
          repository: rhett-lee/skia_compile
          path: skia_compile
          fetch-depth: 1

      # 3. 拉取Skia源码并应用补丁
      - name: Checkout and patch Skia
        working-directory: ${{ env.WORKSPACE }}
        shell: cmd
        run: |
          set SKIA_PATCH_SRC_ZIP=skia.2025-06-06.src.zip
          
          :: 克隆Skia仓库
          if not exist skia (
            git clone https://github.com/google/skia.git
          ) else (
            cd skia
            git stash
            git checkout main
            git pull
            cd ..
          )
          
          :: 切换到指定Commit（参考编译脚本）
          cd skia
          git checkout 290495056ba5b737330ae7f2e6e722eeda9526f8
          cd ..
          
          :: 应用补丁
          if not exist "skia_compile\%SKIA_PATCH_SRC_ZIP%" (
            echo Error: skia_compile\%SKIA_PATCH_SRC_ZIP% not found!
            exit 1
          )
          skia_compile\windows\bin\miniunz.exe -o skia_compile\%SKIA_PATCH_SRC_ZIP% -d ./skia/

      # 4. 安装依赖工具
      - name: Install dependencies
        run: |
          :: 安装Python
          choco install -y python --version=3.11.0
          :: 安装Ninja
          pip install ninja
          :: 安装LLVM（参考脚本中使用LLVM编译）
          choco install -y llvm --version=17.0.6
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
        shell: cmd

      # 5. 验证工具安装
      - name: Verify tools
        run: |
          clang --version
          clang++ --version
          python --version
          ninja --version
        shell: cmd

      # 6. 配置GN编译参数
      - name: Configure GN Args (${{ matrix.config }})
        working-directory: ${{ env.WORKSPACE }}\skia
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $isDebug = $config -eq "Debug"
          $runtime = if ($isDebug) { "/MTd" } else { "/MT" }
          
          $gnArgs = @"
          target_cpu="x64"
          cc="clang"
          cxx="clang++"
          clang_win="C:\Program Files\LLVM"
          is_trivial_abi=false
          is_official_build=$(!$isDebug)
          is_debug=$isDebug
          skia_use_libwebp_encode=false
          skia_use_libwebp_decode=false
          skia_use_libpng_encode=false
          skia_use_libpng_decode=false
          skia_use_zlib=false
          skia_use_libjpeg_turbo_encode=false
          skia_use_libjpeg_turbo_decode=false
          skia_enable_fontmgr_win_gdi=false
          skia_use_icu=false
          skia_use_expat=false
          skia_use_xps=false
          skia_enable_pdf=false
          skia_use_wuffs=false
          skia_enable_svg=true
          skia_use_expat=true
          skia_use_system_expat=false
          extra_cflags=["-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER", "$runtime"]
          "@
          
          Write-Output "GN Args:"
          Write-Output $gnArgs
          gn gen out/$config --args=$gnArgs

      # 7. 编译Skia静态库
      - name: Build Skia Static Lib (${{ matrix.config }})
        working-directory: ${{ env.WORKSPACE }}\skia
        shell: cmd
        run: |
          ninja -C out/${{ matrix.config }} -j 4
        timeout-minutes: 60

      # 8. 验证编译产物
      - name: Verify Build Outputs (${{ matrix.config }})
        working-directory: ${{ env.WORKSPACE }}\skia
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $libPath = "out/$config/skia.lib"
          
          if (-not (Test-Path $libPath)) {
            Write-Error "skia.lib not found at $libPath"
            Get-ChildItem out/$config -Recurse | Format-List
            exit 1
          }
          Write-Host "✅ Found skia.lib at $libPath"
          Write-Host "Size: $(Get-Item $libPath).Length bytes"

      # 9. 打包静态库和头文件
      - name: Package ${{ matrix.config }}
        working-directory: ${{ env.WORKSPACE }}
        shell: powershell
        run: |
          $config = "${{ matrix.config }}"
          $outDir = "package/$config"
          $libPath = "skia/out/$config/skia.lib"
          
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          Copy-Item $libPath -Destination "$outDir/skia.lib"
          robocopy "skia/include" "$outDir/include" /E /NJH /NJS /NFL /NDL
          
          "Skia chrome/m142 static build" | Out-File "$outDir/VERSION.txt"
          "Config: $config" | Out-File -Append "$outDir/VERSION.txt"
          Get-Date -Format "yyyy-MM-dd HH:mm" | Out-File -Append "$outDir/VERSION.txt"

      # 10. 上传编译产物
      - name: Upload Artifact ${{ matrix.config }}
        uses: actions/upload-artifact@v4
        with:
          name: skia-windows-x64-static-${{ matrix.config }}-m142
          path: ${{ env.WORKSPACE }}/package/${{ matrix.config }}
          retention-days: 30
