name: Build Skia m142 (Windows x64 static, LLVM)

on:
  push:
    branches: [ chrome/m142 ]
  pull_request:
    branches: [ chrome/m142 ]
  workflow_dispatch:

env:
  SKIA_VERSION: m142
  LLVM_URL: https://github.com/llvm/llvm-project/releases/download/llvmorg-19.1.0/LLVM-19.1.0-win64.exe
  DEPOT_TOOLS_URL: https://storage.googleapis.com/chrome-infra/depot_tools.zip
  LLVM_PATH: C:/LLVM
  # 优化的核心 2D 图形功能配置
  GN_ARGS_BASE: |
    # 基础构建配置
    target_cpu="x64"
    is_component_build=false
    clang_win="C:/LLVM"
    cc="clang-cl"
    cxx="clang-cl"
    
    # 核心 2D 图形能力
    skia_enable_svg=true
    skia_enable_gpu=true
    skia_use_angle=true
    
    # 修复 JPEG/PNG 问题的关键设置
    skia_use_system_libjpeg=false
    skia_use_system_libpng=false
    skia_use_system_zlib=false
    skia_use_system_webp=false
    
    # 高级文本渲染
    skia_enable_paragraph=true
    skia_enable_skshaper=true
    skia_use_system_freetype2=false
    skia_use_icu=true
    skia_use_system_icu=false
    
    # 视觉效果
    skia_enable_skottie=true
    skia_enable_effects=true
    skia_enable_filters=true
    
    # XML 支持
    skia_use_expat=true
    skia_use_system_expat=false
    
    # 冗余功能裁剪
    skia_use_xps=false
    skia_enable_pdf=false
    skia_enable_flutter_defines=false
    skia_enable_nvpr=false
    skia_enable_spirv_validation=false
  RELEASE_NAME: "Skia-m142-Nightly-Windows"

jobs:
  build:
    runs-on: windows-2022
    strategy:
      matrix:
        config: [Release, Debug]
    steps:
      - name: Checkout Skia (from own repo)
        run: |
          git clone https://github.com/ymzcmy/skia.git skia
          cd skia
          git checkout chrome/${{ env.SKIA_VERSION }}
          git submodule update --init --recursive

      - name: Install Depot Tools (with update)
        run: |
          curl -Lo depot_tools.zip ${{ env.DEPOT_TOOLS_URL }}
          7z x depot_tools.zip -o"C:\depot_tools" -y
          echo "C:\depot_tools" >> $env:GITHUB_PATH
          cd C:\depot_tools
          git checkout main
          git pull

      - name: Initialize depot_tools
        run: |
          cd C:\depot_tools
          echo "solutions = []" > .gclient
          gclient
          del .gclient

      - name: Install LLVM (silent install)
        shell: pwsh
        run: |
          $installPath = "C:\LLVM"
          
          if (-not (Test-Path $installPath)) {
            New-Item -ItemType Directory -Path $installPath -Force | Out-Null
          }
          
          $llvmExe = Join-Path $env:TEMP "llvm.exe"
          Invoke-WebRequest -Uri ${{ env.LLVM_URL }} -OutFile $llvmExe
          
          $installArgs = "/S", "/D=$installPath"
          $proc = Start-Process -FilePath $llvmExe -ArgumentList $installArgs -Wait -PassThru -NoNewWindow
          
          if ($proc.ExitCode -ne 0) {
            Write-Error "LLVM 安装失败! 退出码: $($proc.ExitCode)"
            exit 1
          }
          
          $clangPath = Join-Path $installPath "bin\clang-cl.exe"
          if (-not (Test-Path $clangPath)) {
            $llvmDir = Get-ChildItem -Path $installPath -Directory | Select-Object -First 1
            if ($llvmDir) {
              $clangPath = Join-Path $llvmDir.FullName "bin\clang-cl.exe"
              $installPath = $llvmDir.FullName
            }
          }
          
          if (-not (Test-Path $clangPath)) {
            Write-Error "clang-cl.exe 不存在!"
            exit 1
          }
          
          $env:Path += ";$installPath\bin"
          [System.Environment]::SetEnvironmentVariable("Path", $env:Path, "Machine")

      - name: 创建 emsdk 防御脚本
        shell: pwsh
        working-directory: skia
        run: |
          $binPath = Join-Path -Path $pwd -ChildPath "bin"
          if (-not (Test-Path $binPath)) {
            New-Item -ItemType Directory -Path $binPath -Force | Out-Null
          }
          
          $pyContent = "import sys`r`nsys.exit(0)"
          $pyPath = Join-Path $binPath "activate-emsdk"
          [System.IO.File]::WriteAllText($pyPath, $pyContent)
          
          $batContent = "@echo off`r`nexit /b 0"
          $batPath = Join-Path $binPath "activate-emsdk.bat"
          [System.IO.File]::WriteAllText($batPath, $batContent)
          
          $ps1Content = "exit 0"
          $ps1Path = Join-Path $binPath "activate-emsdk.ps1"
          [System.IO.File]::WriteAllText($ps1Path, $ps1Content)
          
          # 验证脚本
          & python $pyPath
          if ($LASTEXITCODE -ne 0) { exit 1 }
          & cmd /c $batPath
          if ($LASTEXITCODE -ne 0) { exit 1 }
          
          [Environment]::SetEnvironmentVariable("NO_EMSCRIPTEN", "1", "Process")

      - name: 同步第三方依赖
        working-directory: skia
        shell: pwsh
        run: |
          $python = "C:\hostedtoolcache\windows\Python\3.9.13\x64\python.exe"
          if (-not (Test-Path $python)) {
            Write-Error "Python 未找到!"
            exit 1
          }
          
          & $python tools\git-sync-deps --deps-target=win --no-emsdk
          if ($LASTEXITCODE -ne 0) {
            Write-Error "依赖同步失败! 退出码: $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      # ===== 关键修复：正确获取 GN_ARGS_BASE =====
      - name: 生成 GN 构建参数
        shell: pwsh
        working-directory: skia
        run: |
          # 直接内联 GN_ARGS_BASE 内容，避免环境变量引用问题
          $gnArgs = @"
          # 基础构建配置
          target_cpu="x64"
          is_component_build=false
          clang_win="C:/LLVM"
          cc="clang-cl"
          cxx="clang-cl"
          
          # 核心 2D 图形能力
          skia_enable_svg=true
          skia_enable_gpu=true
          skia_use_angle=true
          
          # 修复 JPEG/PNG 问题的关键设置
          skia_use_system_libjpeg=false
          skia_use_system_libpng=false
          skia_use_system_zlib=false
          skia_use_system_webp=false
          
          # 高级文本渲染
          skia_enable_paragraph=true
          skia_enable_skshaper=true
          skia_use_system_freetype2=false
          skia_use_icu=true
          skia_use_system_icu=false
          
          # 视觉效果
          skia_enable_skottie=true
          skia_enable_effects=true
          skia_enable_filters=true
          
          # XML 支持
          skia_use_expat=true
          skia_use_system_expat=false
          
          # 冗余功能裁剪
          skia_use_xps=false
          skia_enable_pdf=false
          skia_enable_flutter_defines=false
          skia_enable_nvpr=false
          skia_enable_spirv_validation=false
          "@
          
          if ("${{ matrix.config }}" -eq "Debug") {
            $gnArgs = $gnArgs + "`n`nis_debug=true`nis_official_build=false`nextra_cflags=[`"/MTd`"]`n"
          } else {
            $gnArgs = $gnArgs + "`n`nis_debug=false`nis_official_build=true`nextra_cflags=[`"/MT`"]`n"
          }
          
          $outDir = "out\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          
          $argsPath = Join-Path -Path $outDir -ChildPath "args.gn"
          [System.IO.File]::WriteAllText($argsPath, $gnArgs)

      - name: 用 GN 生成构建文件
        working-directory: skia
        run: |
          gn gen "out/${{ matrix.config }}"

      - name: 用 Ninja 编译
        working-directory: skia
        run: ninja -C "out/${{ matrix.config }}" skia

      - name: 收集构建产物
        shell: pwsh
        working-directory: skia
        run: |
          $config = "${{ matrix.config }}"
          $dst = "${{ github.workspace }}\skia-${{ env.SKIA_VERSION }}-windows-x64-${config}"
          
          New-Item -Path "$dst\include" -ItemType Directory -Force | Out-Null
          New-Item -Path "$dst\lib" -ItemType Directory -Force | Out-Null
          
          robocopy "include" "$dst\include" /E /NP /NFL /NDL /R:1 /W:1
          if ($LASTEXITCODE -gt 7) { exit $LASTEXITCODE }
          
          Copy-Item "out\${config}\*.lib" -Destination "$dst\lib" -Force
          Copy-Item "out\${config}\args.gn" -Destination "$dst" -Force
          Copy-Item "LICENSE" -Destination "$dst" -Force
          
          Compress-Archive -Path "$dst\*" -DestinationPath "${dst}.zip" -Force

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}
          path: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip

      - name: 上传到 Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/chrome/m142'
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_NAME }}
          update: true
          body: |
            **Skia m142 自动构建 (Windows x64)**
            
            Skia 是一个完整的 2D 图形库，用于绘制**文本**、**几何图形**和**图像**。
            
            **构建详情**:
            - 分支: `${{ github.ref_name }}`  
            - 提交: `${{ github.sha }}`  
            - 配置: `${{ matrix.config }}`  
            - 核心功能:
              - GPU 加速渲染 (ANGLE)
              - SVG 矢量图形
              - 高级文本排版
              - 动画支持
            - 裁剪功能:
              - WebP 图像格式
              - XPS 文档
              - PDF 生成
            
            > 此构建针对 Windows x64 平台优化，使用 LLVM 19.1.0 编译
          files: skia-${{ env.SKIA_VERSION }}-windows-x64-${{ matrix.config }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
